(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}})();const ct="vite-refactor/6.1.0",dt="https://your-make-webhook-url.com/your-unique-path",ge="marnthara.input.v6.1",ut=500,te={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยืนการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},pt=1.19599,mt={ROLL_WIDTH_M:.53,STRIPS_PER_ROLL_UNDER_2_5M:3},be={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200,2300,2400,2500,2600,2700,2800,2900,3e3],sheer:[1e3,1100,1200,1300,1400,1500],louis:[2200,2300,2400,2500,2600,2700,2800,2900,3e3,3100,3200,3300,3400,3500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0,ม่านแป๊บ:0,หลุยส์:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},J={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},m={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",roomDefaultsBtn:'[data-act="open-room-defaults"]',itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setLouisPricePerMSelect:'select[name="louis_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setLouisValanceInput:'input[name="louis_valance"]',setLouisTasselsInput:'input[name="louis_tassels"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",pdfOptionsModal:"#pdfOptionsModal",exportPdfWithDetailsBtn:"#exportPdfWithDetailsBtn",exportPdfWithoutDetailsBtn:"#exportPdfWithoutDetailsBtn",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',modalLouisValance:'[name="modal_louis_valance"]',modalLouisTassels:'[name="modal_louis_tassels"]',trackColorGroup:"#trackColorGroup",bracketColorGroup:"#bracketColorGroup",finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",louisValanceGroup:"#louisValanceGroup",louisTasselGroup:"#louisTasselGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',roomDefaultsModal:"#roomDefaultsModal",roomDefaultsForm:"#roomDefaultsForm",roomDefaultsApplyBtn:"#roomDefaultsApplyBtn",roomDefaultsConfirmBtn:"#roomDefaultsConfirmBtn",roomDefaultsCancelBtn:"#roomDefaultsCancelBtn",overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},v=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const o=parseFloat(e);return Number.isFinite(o)?o:0},V=e=>{const o=v(e);return o>0?o.toFixed(2):""},He=e=>{const o=e.target,a=o.value.trim();if(a===""){o.value="";return}let t=v(a);if(t<=0){o.value="";return}a.includes(".")||(t=t/100),o.value=V(t)},j=(e,o=2,a=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:a?2:o,maximumFractionDigits:a?2:o}):"0",S=(e,o=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:o,maximumFractionDigits:o}):"0",qe=(e,o=150)=>{let a;return(...t)=>{clearTimeout(a),a=setTimeout(()=>e(...t),o)}},ft=(e,o=200)=>{let a=0,t;return(...r)=>{const s=new Date().getTime();t&&(clearTimeout(t),t=null),s-a>=o?(a=s,e(...r)):t=setTimeout(()=>{a=new Date().getTime(),e(...r),t=null},o-(s-a))}},L=e=>e?e.replace(/[<>"'&]/g,o=>{switch(o){case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";case"&":return"&amp;";default:return o}}):"",ht=e=>e.replace(/[<>:"/\\|?*]/g,"").replace(/[\s\n\t]+/g,"_").substring(0,100);function We(e){if(e=v(e),e===0)return"ศูนย์บาทถ้วน";if(e<0||e>99999999999999e-2)return"N/A";const o=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า","สิบ"],a=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];e=parseFloat(e.toFixed(2));let t=Math.floor(e),r=Math.round((e-t)*100);const s=i=>{if(i===0)return"";let l="";const d=String(i);for(let c=0;c<d.length;c++){const p=d[c],u=d.length-c-1;p!=="0"&&(u===1&&p==="1"?l+=a[u]:u===1&&p==="2"?l+="ยี่"+a[u]:u===0&&p==="1"&&d.length>1?l+="เอ็ด":l+=o[parseInt(p)]+a[u])}return l};let n="";if(t>0){const i=Math.floor(t/1e6),l=t%1e6;i>0&&(n+=s(i)+"ล้าน"),n+=s(l),n+="บาท"}else n="ศูนย์บาท";return r===0?n+="ถ้วน":n+=s(r)+"สตางค์",n}const je="marnthara.favorites.v4",Se={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function ce(){try{const e=localStorage.getItem(je);return e?{...Se,...JSON.parse(e)}:Se}catch(e){return console.error("Failed to parse favorites from localStorage",e),Se}}function Ie(e){try{localStorage.setItem(je,JSON.stringify(e))}catch(o){console.error("Failed to save favorites to localStorage",o)}}function Ge(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const o={...Se,...e};return Ie(o),!0}function Re(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const o=ce();let a=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(o[t]||(o[t]=[]),e[t].forEach(r=>{r&&r.code&&r.hasOwnProperty("price")?o[t].some(n=>n.code===r.code)||(o[t].push({code:r.code,price:r.price}),a++):console.warn(`Skipping invalid favorite item during merge for type ${t}:`,r)}),o[t].sort((r,s)=>r.code.localeCompare(s.code)));return a>0&&Ie(o),a}function Ue(e,o,a){const t=ce(),r=o?.trim();if(!r)return console.error(`Attempted to add favorite with empty code for type: ${e}`),!1;if(typeof a!="number"||isNaN(a)||a<0)return console.error(`Attempted to add favorite with invalid price (${a}) for code ${r}`),!1;if(!Object.hasOwnProperty.call(Se,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]||(t[e]=[]);const s=t[e],n=s.find(i=>i.code===r);return n?n.price=a:s.push({code:r,price:a}),s.sort((i,l)=>i.code.localeCompare(l.code)),Ie(t),!0}function Ye(e,o){const a=ce(),t=o?.trim();if(!a[e]||!t)return!1;const r=a[e].findIndex(s=>s.code===t);return r>-1?(a[e].splice(r,1),Ie(a),!0):!1}function yt(){localStorage.removeItem(je),console.log("All favorites have been cleared.")}function O(){const e=ce(),o={app_version:ct,customer_name:document.querySelector(m.customerNameInput)?.value||"",customer_phone:document.querySelector(m.customerPhoneInput)?.value||"",customer_address:document.querySelector(m.customerAddressInput)?.value||"",customer_card_open:document.querySelector(m.customerCard)?.open,discount:{type:document.querySelector(m.discountTypeInput)?.value||"amount",value:v(document.querySelector(m.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(m.room).forEach(a=>{const t={id:a.id,room_name:a.querySelector(m.roomNameInput)?.value||"",is_suspended:a.classList.contains("is-suspended"),is_open:a.open,room_defaults:JSON.parse(a.dataset.roomDefaults||"{}"),items:[]};a.querySelector(m.allItemsContainer)?.childNodes.forEach(r=>{if(r.nodeType!==1||!r.matches(m.itemCard))return;if(r.classList.contains("placeholder-item")){const i={type:"placeholder",is_suspended:r.classList.contains("is-suspended"),width_m:v(r.dataset.widthM),height_m:v(r.dataset.heightM)};t.items.push(i);return}const s=r.dataset.type;if(!s)return;let n={type:s,is_suspended:r.classList.contains("is-suspended")};if(s==="set")Object.assign(n,{width_m:v(r.querySelector(m.setWidthInput)?.value),height_m:v(r.querySelector(m.setHeightInput)?.value),style:r.querySelector(m.setStyleSelect)?.value||"",fabric_variant:r.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:v(r.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:v(r.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:v(r.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:r.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:r.querySelector(m.setSheerCodeInput)?.value||"",opening_style:r.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:r.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:r.querySelector(m.setTrackColorInput)?.value||"ขาว",bracket_color:r.querySelector(m.setBracketColorInput)?.value||"ขาว",finial_color:r.querySelector(m.setFinialColorInput)?.value||"ขาว",grommet_color:r.querySelector(m.setGrommetColorInput)?.value||"เงิน",louis_valance:r.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:r.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:r.querySelector(m.setNotesInput)?.value||""});else if(s==="wallpaper"){const i=r.querySelector(m.wallInstallCostInput),l=i?i.value:"";let d;l==="0"?d=0:v(l)>0?d=v(l):d=void 0,Object.assign(n,{height_m:v(r.querySelector(m.wallHeightInput)?.value),wallpaper_code:r.querySelector(m.wallCodeInput)?.value||"",price_per_roll:v(r.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:d,notes:r.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(r.querySelectorAll(m.wallWidthInput)).map(c=>v(c.value))})}else r.matches(m.areaBasedItem)&&(Object.assign(n,{width_m:v(r.querySelector(m.areaWidthInput)?.value),height_m:v(r.querySelector(m.areaHeightInput)?.value),price_sqyd:v(r.querySelector(m.areaPriceSqydInput)?.value),code:r.querySelector(m.areaCodeInput)?.value||"",notes:r.querySelector(m.areaNotesInput)?.value||""}),(s==="partition"||s==="pleated_screen")&&(n.opening_style=r.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(s)&&(n.adjustment_side=r.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));t.items.push(n)}),o.rooms.push(t)}),o}function W(){try{const e=O();localStorage.setItem(ge,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const fe=[],vt=10;function oe(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const o=JSON.parse(JSON.stringify(e));fe.push(o),fe.length>vt&&fe.shift()}catch(o){console.error("Failed to clone state for undo history:",o)}}function _t(){if(fe.length!==0)return fe.pop()}function gt(){return fe.length>0}const N={stylePlus:e=>be.style_surcharge[e]??0,heightPlus:e=>{const o=[...be.height].sort((a,t)=>t.threshold-a.threshold);for(const a of o)if(e>a.threshold)return a.add_per_m;return 0},fabricYardage:(e,o)=>{const a=v(o);if(a<=0)return 0;let t=0;switch(e){case"ลอน":case"ตาไก่":case"จีบ":case"ม่านแป๊บ":t=2.5;break;case"ม่านพับ":t=1.2;break;case"หลุยส์":t=0;break}return a*t*1.09361},_calculateComponentPrice:e=>{const o=v(e.width),a=v(e.height),t=v(e.price_per_m);if(o<=0||a<=0||t<=0)return 0;const r=N.stylePlus(e.style),s=N.heightPlus(a);N.fabricYardage(e.style,o);let n=0;switch(e.style){case"ลอน":case"ตาไก่":case"จีบ":case"ม่านแป๊บ":n=2.5;break;case"ม่านพับ":n=1.2;break;case"หลุยส์":n=2.5;break}if(n===0)return 0;const i=t,l=r+s,d=(i+l)*o*n;return Math.round(d/10)*10},calculateSetPrice:function(e){if(!e||e.is_suspended)return{total:0,opaque:0,sheer:0,louis:0};const o=e.fabric_variant||"ทึบ",a=e.style||"ลอน",t=v(e.width_m),r=v(e.height_m);let s=0,n=0,i=0;if(a==="หลุยส์"){const d=v(e.louis_price_per_m);t>0&&d>0&&(i=d*t,i=Math.round(i/10)*10),o.includes("ทึบ")&&(s=this._calculateComponentPrice({style:a,width:t,height:r,price_per_m:e.price_per_m_raw})),o.includes("โปร่ง")&&(n=this._calculateComponentPrice({style:a,width:t,height:r,price_per_m:e.sheer_price_per_m}))}else o.includes("ทึบ")&&(s=this._calculateComponentPrice({style:a,width:t,height:r,price_per_m:e.price_per_m_raw})),o.includes("โปร่ง")&&(n=this._calculateComponentPrice({style:a,width:t,height:r,price_per_m:e.sheer_price_per_m}));return{total:s+n+i,opaque:s,sheer:n,louis:i}},wallpaperRolls:(e,o)=>{if(e<=0||o<=0)return 0;const{ROLL_WIDTH_M:a,STRIPS_PER_ROLL_UNDER_2_5M:t}=mt,r=Math.ceil(e/a);let s;return o<=2.5?s=t:o<=3.3?s=2:s=1,Math.ceil(r/s)},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended)return{total:0,sqm:0,sqyd:0};const o=v(e.width_m),a=v(e.height_m),t=v(e.price_sqyd);if(o<=0||a<=0||t<=0)return{total:0,sqm:0,sqyd:0};const r=o*a;let s=r*pt;s<1?s=1:s=Math.ceil(s*2)/2;const n=s*t;return{total:Math.round(n),sqm:r,sqyd:s}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=e.widths?.reduce((i,l)=>i+v(l),0)||0;if(o<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const a=v(e.height_m),t=this.wallpaperRolls(o,a),r=t*v(e.price_per_roll),s=e.install_cost_per_roll===""||e.install_cost_per_roll===null||e.install_cost_per_roll===void 0?300:v(e.install_cost_per_roll),n=t*s;return{total:Math.round(r+n),material:Math.round(r),install:Math.round(n),rolls:t,sqm:o*a}}},de=Object.entries(J).reduce((e,[o,a])=>(e[o]=a.name,e),{});de.set_louis="ม่านหลุยส์";function Ze(e){const{width:o=0,height:a=0}=e,t=15,r=100-t*2,s=100-t*2,n=o>0&&a>0?Math.min(r/o,s/a):1,i=o*n,l=a*n,d=(100-i)/2,c=(100-l)/2,p=o>0?`${j(o,2)} ม.`:"?",u=a>0?`${j(a,2)} ม.`:"?",h=`
        <line x1="${d}" y1="${c-5}" x2="${d+i}" y2="${c-5}" class="svg-dim-line" />
        <line x1="${d}" y1="${c-7}" x2="${d}" y2="${c-3}" class="svg-dim-line" />
        <line x1="${d+i}" y1="${c-7}" x2="${d+i}" y2="${c-3}" class="svg-dim-line" />
        <text x="${d+i/2}" y="${c-8}" class="svg-dim-text">${p}</text>

        <line x1="${d-5}" y1="${c}" x2="${d-5}" y2="${c+l}" class="svg-dim-line" />
        <line x1="${d-7}" y1="${c}" x2="${d-3}" y2="${c}" class="svg-dim-line" />
        <line x1="${d-7}" y1="${c+l}" x2="${d-3}" y2="${c+l}" class="svg-dim-line" />
        <text x="${d-8}" y="${c+l/2}" class="svg-dim-text" transform="rotate(-90, ${d-8}, ${c+l/2})">${u}</text>
    `;return{x:d,y:c,svgWidth:i,svgHeight:l,dimensionLines:h}}function bt(e){const{x:o,y:a,svgWidth:t,svgHeight:r,dimensionLines:s}=Ze({width:v(e.width_m),height:v(e.height_m)});let n="",i="";const l=e.opening_style==="แยกกลาง"&&e.style!=="ม่านพับ"?2:0;switch(e.style){case"ตาไก่":i=`<rect x="${o-2}" y="${a-1}" width="${t+4}" height="3" class="svg-rod" />`;const d=Math.max(2,Math.floor(t/5));for(let q=0;q<d;q++){const $=o+(t/(d-1)||0)*q;i+=`<circle cx="${$}" cy="${a+2.5}" r="1.5" class="svg-grommet-hole" />`}n=`<path d="M${o},${a} C${o+t*.25},${a+10} ${o+t*.75},${a-10} ${o+t},${a} L${o+t},${a+r} C${o+t*.75},${a+r-10} ${o+t*.25},${a+r+10} ${o},${a+r} Z" class="svg-fabric" />`;break;case"จีบ":case"ลอน":i=`<rect x="${o}" y="${a-1}" width="${t}" height="2.5" class="svg-track" />`,n=`<path d="M${o},${a} C${o+t*.25},${a+10} ${o+t*.75},${a-10} ${o+t},${a} L${o+t},${a+r} C${o+t*.75},${a+r-10} ${o+t*.25},${a+r+10} ${o},${a+r} Z" class="svg-fabric" />`;break;case"ม่านแป๊บ":const c=a+2.5,p=1.5,u=2,h=p*2+1,g=a+u+h;i=`<rect x="${o-2}" y="${c-p}" width="${t+4}" height="${p*2}" class="svg-rod" />`;const y=Math.max(5,Math.floor(t/4));let f=`M${o},${a}`;for(let q=0;q<=y;q++){const $=o+t/y*q,T=q%2===0?a-.5:a+.5;q===0?f+=` L${$},${a}`:f+=` Q${$-t/y/2},${T} ${$},${a}`}f+=` L${o+t},${g}`;for(let q=y;q>=0;q--){const $=o+t/y*q,T=q%2===0?a+r-2:a+r+2;q===y?f+=` L${$},${a+r}`:f+=` Q${$+t/y/2},${T} ${$},${a+r}`}f+=` L${o},${g}`,f+=` Z M${o},${g}`;for(let q=0;q<=y;q++){const $=o+t/y*q,T=q%2===0?g-.5:g+.5;q===0?f+=` L${$},${g}`:f+=` Q${$-t/y/2},${T} ${$},${g}`}n=`<path d="${f} Z" class="svg-fabric svg-fabric-gathered" />`;break;case"ม่านพับ":i=`<rect x="${o}" y="${a-1}" width="${t}" height="2.5" class="svg-track" />`,n=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-fabric" />`;const _=5;for(let q=1;q<=_;q++){const $=a+r/_*q;n+=`<line x1="${o}" y1="${$}" x2="${o+t}" y2="${$}" class="svg-fold-line" />`}break;case"หลุยส์":i=`<rect x="${o}" y="${a-1}" width="${t}" height="2.5" class="svg-track" />`;const w=Math.max(8,r*.15);i+=`<rect x="${o}" y="${a}" width="${t}" height="${w}" class="svg-louis-valance" />`;const k=Math.max(1,Math.floor(t/20)),x=t/k;for(let q=0;q<k;q++){const $=o+q*x;i+=`<path d="M${$},${a+w*.8} Q${$+x/2},${a+w+10} ${$+x},${a+w*.8}" class="svg-louis-swag" />`}n=`<rect x="${o}" y="${a+w}" width="${t}" height="${r-w}" class="svg-fabric" />`,l=0;break;default:n=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-fabric" />`}return l>0&&(n+=`<line x1="${o+t/2-l/2}" y1="${a}" x2="${o+t/2-l/2}" y2="${a+r}" class="svg-opening-line" />`,n+=`<line x1="${o+t/2+l/2}" y1="${a}" x2="${o+t/2+l/2}" y2="${a+r}" class="svg-opening-line" />`),`
    <svg class="item-visual" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        ${s}
        <g class="svg-curtain-group" transform="translate(0, 5)"> ${n} ${i} </g>
    </svg>`}function Je(e){const{x:o,y:a,svgWidth:t,svgHeight:r,dimensionLines:s}=Ze({width:v(e.width_m),height:v(e.height_m)});let n="";switch(e.type){case"wallpaper":n=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-wallpaper" />`,n+=`<path d="M${o+5},${a} L${o},${a+5} M${o+10},${a} L${o},${a+10} M${o+15},${a} L${o},${a+15}" class="svg-wallpaper-pattern" />`;break;case"wooden_blind":case"aluminum_blind":n=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-blind" />`;const i=10;for(let c=1;c<=i;c++){const p=a+r/i*c;n+=`<line x1="${o}" y1="${p}" x2="${o+t}" y2="${p}" class="svg-blind-slat" />`}break;case"roller_blind":n=`<rect x="${o-1}" y="${a-1}" width="${t+2}" height="2.5" class="svg-track" />`,n+=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-blind" />`;break;case"vertical_blind":n=`<rect x="${o-1}" y="${a-1}" width="${t+2}" height="2.5" class="svg-track" />`,n+=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-blind" />`;const l=Math.max(2,Math.floor(t/8));for(let c=1;c<l;c++){const p=o+t/l*c;n+=`<line x1="${p}" y1="${a}" x2="${p}" y2="${a+r}" class="svg-blind-slat" />`}break;case"partition":case"pleated_screen":n=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-blind" />`;const d=Math.max(2,Math.floor(t/5));for(let c=1;c<d;c++){const p=o+t/d*c;n+=`<line x1="${p}" y1="${a}" x2="${p}" y2="${a+r}" class="svg-fold-line" />`}break;default:n=`<rect x="${o}" y="${a}" width="${t}" height="${r}" class="svg-default-item" />`}return`
    <svg class="item-visual" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        ${s}
        <g class="svg-item-group" transform="translate(0, 5)"> ${n}
        </g>
    </svg>`}function St(e){return e.style==="หลุยส์"?de.set_louis||"ม่านหลุยส์":de.set||"ผ้าม่าน"}function et(e){const o=v(e.width_m),a=v(e.height_m);let t=[`<b>${L(e.style)}</b>`,`ขนาด ${o>0?j(o,2):"?"} x ${a>0?j(a,2):"?"} ม.`];if(e.style==="หลุยส์"?(t.push(`<b>${L(e.fabric_variant)}</b>`),v(e.louis_price_per_m)>0&&t.push(`หลุยส์ ม.ละ ${S(e.louis_price_per_m)}`)):e.style==="ม่านพับ"?t.push(L(e.adjustment_side)):e.style!=="ม่านแป๊บ"&&t.push(L(e.opening_style)),e.fabric_variant.includes("ทึบ")&&e.style!=="หลุยส์"||e.style==="หลุยส์"&&e.fabric_variant.includes("ทึบ")){const s=L(e.fabric_code)||"-",n=v(e.price_per_m_raw);t.push(`ทึบ: ${s} (${n>0?S(n):"ฟรี"})`)}if(e.fabric_variant.includes("โปร่ง")&&e.style!=="หลุยส์"||e.style==="หลุยส์"&&e.fabric_variant.includes("โปร่ง")){const s=L(e.sheer_fabric_code)||"-",n=v(e.sheer_price_per_m);t.push(`โปร่ง: ${s} (${n>0?S(n):"ฟรี"})`)}let r=[];return e.style==="ตาไก่"?(r.push(`ห่วง ${L(e.grommet_color)}`),r.push(`ราง ${L(e.finial_color)}`)):e.style==="หลุยส์"?(r.push(`หัว ${L(e.louis_valance)}`),r.push(`พู่ ${L(e.louis_tassels)}`)):e.style==="ม่านพับ"||(e.style==="ม่านแป๊บ"?r.push(`ราว ${L(e.finial_color)}`):r.push(`ราง ${L(e.track_color)}`)),r.length>0&&t.push(r.join(", ")),e.notes&&t.push(`<i>หมายเหตุ: ${L(e.notes)}</i>`),t.join(" &bull; ")}function tt(e){const o=v(e.width_m),a=v(e.height_m),t=L(e.code)||"-",r=v(e.price_sqyd);let s=[`รหัส ${t}`,`ขนาด ${o>0?j(o,2):"?"} x ${a>0?j(a,2):"?"} ม.`,`ราคา ${r>0?S(r):"0"} /ตร.หลา`];return e.opening_style&&s.push(`เปิด${L(e.opening_style)}`),e.adjustment_side&&s.push(`ปรับ${L(e.adjustment_side)}`),e.notes&&s.push(`<i>หมายเหตุ: ${L(e.notes)}</i>`),s.join(" &bull; ")}function ot(e){const o=v(e.height_m),a=L(e.wallpaper_code)||"-",t=v(e.price_per_roll),r=v(e.install_cost_per_roll),s=e.widths.map(l=>v(l)).filter(l=>l>0),n=s.reduce((l,d)=>l+d,0);let i=[`รหัส ${a}`,`สูง ${o>0?j(o,2):"?"} ม.`,`ราคา ${t>0?S(t):"0"} /ม้วน`,`ค่าช่าง ${S(r)} /ม้วน`];return n>0&&i.push(`ผนัง ${s.map(l=>j(l,2)).join(", ")} ม. (กว้างรวม ${j(n,2)} ม.)`),e.notes&&i.push(`<i>หมายเหตุ: ${L(e.notes)}</i>`),i.join(" &bull; ")}function wt(e,o="customer"){let a=`สรุปรายการ - ${te.name}
`;a+=`-----------------------------------
`,(o==="customer"||o==="owner")&&(()=>{a+=`ลูกค้า: ${e.customer_name||"-"}
`,a+=`โทร: ${e.customer_phone||"-"}
`,o==="owner"&&(a+=`ที่อยู่: ${e.customer_address||"-"}
`),a+=`-----------------------------------
`})();let r=0,s=!1,n={fabric:{},sheer:{},wallpaper:{},area:{}};if(e.rooms.forEach(i=>{if(i.is_suspended)return;let l=`
🔷 ${i.room_name||"ห้อง (ไม่มีชื่อ)"}
`,d=!1;i.items.forEach((c,p)=>{if(c.is_suspended||!c.type)return;const u=v(c.width_m),h=v(c.height_m),g=v(c.total_price);r+=g,d=!0,s=!0;const y=`${p+1}. `;let f=[];switch(c.type){case"set":const _=St(c);if(a+=`${y}${_}: ${c.style} (${u} x ${h} ม.)
`,o==="seamstress"||o==="owner"){if(c.style!=="ม่านพับ"&&c.style!=="หลุยส์"&&c.style!=="ม่านแป๊บ"&&f.push(`เปิด${c.opening_style}`),c.style==="ม่านพับ"&&f.push(`ปรับ${c.adjustment_side}`),c.fabric_variant.includes("ทึบ")||c.style==="หลุยส์"){const M=c.fabric_code||"-";f.push(`ทึบ: ${M}`),M!=="-"&&(o==="purchase_order"||o==="owner")&&(n.fabric[M]=(n.fabric[M]||0)+N.fabricYardage(c.style,u))}if(c.fabric_variant.includes("โปร่ง")){const M=c.sheer_fabric_code||"-";f.push(`โปร่ง: ${M}`),M!=="-"&&(o==="purchase_order"||o==="owner")&&(n.sheer[M]=(n.sheer[M]||0)+N.fabricYardage(c.style,u))}c.style==="หลุยส์"&&(f.push(`หัว ${c.louis_valance}`),f.push(`พู่ ${c.louis_tassels}`))}(o==="customer"||o==="owner")&&(a+=`   ราคา: ${S(g)} บาท
`),c.notes&&(o==="seamstress"||o==="owner")&&f.push(`Note: ${c.notes}`);break;case"wallpaper":const w=de[c.type]||"วอลล์เปเปอร์",k=c.widths.map(M=>v(M)).filter(M=>M>0),x=k.reduce((M,I)=>M+I,0),q=N.wallpaperRolls(x,h);if(a+=`${y}${w}: สูง ${h} ม. (รวม ${q} ม้วน)
`,o==="seamstress"||o==="owner"){f.push(`กว้าง: ${k.join(", ")} ม.`);const M=c.wallpaper_code||"-";f.push(`รหัส: ${M}`),M!=="-"&&(o==="purchase_order"||o==="owner")&&(n.wallpaper[M]=(n.wallpaper[M]||0)+q)}(o==="customer"||o==="owner")&&(a+=`   ราคา: ${S(g)} บาท
`),c.notes&&(o==="seamstress"||o==="owner")&&f.push(`Note: ${c.notes}`);break;default:const $=de[c.type]||"ของตกแต่ง",T=N.calculateAreaBasedPrice(c);if(a+=`${y}${$}: ${u} x ${h} ม. (${T.sqyd} ตร.หลา)
`,o==="seamstress"||o==="owner"){const M=c.code||"-";if(f.push(`รหัส: ${M}`),c.opening_style&&f.push(`เปิด${c.opening_style}`),c.adjustment_side&&f.push(`ปรับ${c.adjustment_side}`),M!=="-"&&(o==="purchase_order"||o==="owner")){const I=`${$} (${M})`;n.area[I]=(n.area[I]||0)+T.sqyd}}(o==="customer"||o==="owner")&&(a+=`   ราคา: ${S(g)} บาท
`),c.notes&&(o==="seamstress"||o==="owner")&&f.push(`Note: ${c.notes}`);break}f.length>0&&(a+=`   (${f.join(" | ")})
`)}),d&&(a+=l)}),!s)return"ไม่มีรายการสำหรับสรุป";if(o==="customer"||o==="owner"){a+=`-----------------------------------
`,a+=`ยอดรวม: ${S(r)} บาท
`;const i=e.discount?.value||0;if(i>0){const d=(e.discount?.type||"amount")==="percent"?`${i}%`:`${S(i)} บ.`;a+=`ส่วนลด (${d}): -${S(N.calculateDiscountAmount(r,e.discount))} บาท
`;const c=N.calculateGrandTotal(r,e.discount);a+=`ยอดสุทธิ: ${S(c)} บาท
`}a+=`-----------------------------------
`,a+=`ขอบคุณครับ/ค่ะ
${te.name}
${te.phone}`}if(o==="purchase_order"||o==="owner"){a+=`

--- สรุปสั่งของ ---
`;let i="";if(Object.keys(n.fabric).length>0){i+=`ผ้าทึบ (หลา):
`;for(const[l,d]of Object.entries(n.fabric))i+=`  - ${l}: ${j(d,2)} หลา
`}if(Object.keys(n.sheer).length>0){i+=`ผ้าโปร่ง (หลา):
`;for(const[l,d]of Object.entries(n.sheer))i+=`  - ${l}: ${j(d,2)} หลา
`}if(Object.keys(n.wallpaper).length>0){i+=`วอลล์เปเปอร์ (ม้วน):
`;for(const[l,d]of Object.entries(n.wallpaper))i+=`  - ${l}: ${d} ม้วน
`}if(Object.keys(n.area).length>0){i+=`อื่นๆ (ตร.หลา):
`;for(const[l,d]of Object.entries(n.area))i+=`  - ${l}: ${j(d,2)} ตร.หลา
`}i===""&&(i="ไม่มีรายการวัสดุ (อาจจะไม่ได้ใส่รหัส)"),a+=i}return a}async function qt(e,o){const{showDetails:a=!0,vatOption:t="include"}=o,{name:r,address:s,phone:n,taxId:i,logoUrl:l}=te,{paymentTerms:d,priceValidity:c,notes:p}=te.pdf;let u="";try{const A=await fetch(l);if(!A.ok)throw new Error("Logo image not found");const z=await A.blob();u=await new Promise((re,ne)=>{const Q=new FileReader;Q.onloadend=()=>re(`<img src="${Q.result}" class="logo" alt="Logo">`),Q.onerror=ne,Q.readAsDataURL(z)})}catch(A){console.warn("Could not load logo image for PDF:",A),u=`<div class="logo-placeholder">${r}</div>`}const h=t==="exclude"?"ใบเสนอราคา / QUOTATION":"ใบเสนอราคา (รวม VAT) / QUOTATION",g=new Date().toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"});let y=0,f=!1,_=1;const w=30;let k=0;const x=v(o.pageBreakBuffer),q=()=>(k=0,_++,`
            </tbody></table>
            <div class="page-break"></div>
            <div class="page-header" data-page="${_}">หน้า ${_}</div>
            <table class="items-table">
                <thead>
                    <tr>
                        <th class="col-room">ห้อง</th>
                        <th class="col-item">รายการ</th>
                        <th class="col-price">ราคา (บาท)</th>
                    </tr>
                </thead>
                <tbody>
        `);let $="";e.rooms.filter(A=>!A.is_suspended&&A.items.some(z=>!z.is_suspended)).length;for(const A of e.rooms){if(A.is_suspended)continue;const z=A.items.filter(B=>!B.is_suspended&&B.type);if(z.length===0)continue;let re=!0;const ne=L(A.room_name)||"ห้อง (ไม่มีชื่อ)";let Q=`<strong>${ne}</strong>`,E=1+z.length*(a?2:1);k>5&&k+E>w&&($+=q(),Q=`<strong>${ne} (ต่อ)</strong>`);for(const[B,C]of z.entries()){const ae=B===z.length-1,ee=v(C.total_price);y+=ee,f=!0;let pe=1,se="";if(a){switch(C.type){case"set":se=et(C);break;case"wallpaper":se=ot(C);break;default:se=tt(C);break}pe+=1,C.notes&&(pe+=1)}k>0&&k+pe>w-x&&!re&&($+=q(),re=!0,Q=`<strong>${ne} (ต่อ)</strong>`),k+=pe;const me=de[C.type==="set"?C.style==="หลุยส์"?"set_louis":"set":C.type]||"รายการ";$+=`
                <tr class="${ae?"last-in-room":""}">
                    <td class="col-room">${re?Q:""}</td>
                    <td class="col-item">
                        ${L(me)}
                        ${a?`<div class="item-details">${se}</div>`:""}
                    </td>
                    <td class="col-price">${S(ee,2)}</td>
                </tr>
            `,re=!1}}f||($='<tr><td colspan="3" style="text-align: center; padding: 2rem;">--- ไม่มีรายการ ---</td></tr>');const T=N.calculateDiscountAmount(y,e.discount),M=y-T;let I="",Y=0;if(t==="exclude"){Y=M*te.baseVatRate;const A=M+Y;I=`
            <tr><td colspan="2" class="text-right">ยอดรวม (Subtotal)</td><td class="text-right">${S(y,2)}</td></tr>
            ${T>0?`<tr><td colspan="2" class="text-right">ส่วนลด</td><td class="text-right">-${S(T,2)}</td></tr>`:""}
            ${T>0?`<tr><td colspan="2" class="text-right">ยอดคงเหลือ (Total)</td><td class="text-right">${S(M,2)}</td></tr>`:""}
            <tr><td colspan="2" class="text-right">ภาษีมูลค่าเพิ่ม (VAT 7%)</td><td class="text-right">${S(Y,2)}</td></tr>
            <tr class="grand-total"><td colspan="2" class="text-right">ยอดสุทธิ (Grand Total)</td><td class="text-right">${S(A,2)}</td></tr>
            <tr class="total-text"><td colspan="3" class="text-right">(${We(A)})</td></tr>
        `}else Y=M-M/(1+te.baseVatRate),I=`
            <tr><td colspan="2" class="text-right">ยอดรวม (Subtotal)</td><td class="text-right">${S(y,2)}</td></tr>
             ${T>0?`<tr><td colspan="2" class="text-right">ส่วนลด</td><td class="text-right">-${S(T,2)}</td></tr>`:""}
            <tr class="grand-total"><td colspan="2" class="text-right">ยอดสุทธิ (Grand Total)</td><td class="text-right">${S(M,2)}</td></tr>
            <tr><td colspan="2" class="text-right" style="font-size: 0.8em;">(ราคารวมภาษีมูลค่าเพิ่ม)</td><td class="text-right" style="font-size: 0.8em;">${S(Y,2)}</td></tr>
            <tr class="total-text"><td colspan="3" class="text-right">(${We(M)})</td></tr>
        `;return`
    <html>
    <head>
        <meta charset="UTF-8">
        <title>${h}</title>
        <style>
            /* CSS from sandbox03/pdf.css */
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&display=swap');
            :root {
                --font-family: 'Noto Sans Thai', 'Sarabun', sans-serif;
                --text-color: #333;
                --primary-color: #4A69E2;
                --border-color: #DEE2E6;
                --page-bg: #FFF;
                --header-bg: #F8F9FA;
            }
            @page {
                size: A4;
                margin: 20mm 15mm 25mm 15mm;
                 @bottom-left {
                    content: "${te.name} (${te.phone})";
                    font-family: var(--font-family);
                    font-size: 8pt;
                    color: #777;
                }
                 @bottom-right {
                    content: "หน้าที่ " counter(page) " / " counter(pages);
                    font-family: var(--font-family);
                    font-size: 8pt;
                    color: #777;
                }
            }
            body {
                font-family: var(--font-family);
                font-size: 10pt;
                color: var(--text-color);
                line-height: 1.5;
                background-color: var(--page-bg);
            }
            .page {
                width: 100%; /* A4 width approx 210mm - margins */
                height: 100%; /* A4 height approx 297mm - margins */
                position: relative;
            }
            .page-break { page-break-before: always; }
            .page-header {
                position: running(pageHeader); /* Custom name for running header */
                text-align: right;
                font-size: 9pt;
                color: #555;
            }
            /* We build the header *once* in the HTML, and it runs on subsequent pages */
            header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--primary-color);
                margin-bottom: 1rem;
            }
            .logo { max-width: 100px; max-height: 80px; object-fit: contain; }
            .logo-placeholder { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
            .shop-info {
                text-align: right;
                font-size: 9pt;
                line-height: 1.4;
            }
            .shop-info h2 {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--primary-color);
                margin: 0;
            }
            .customer-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 1rem;
                padding: 0.75rem;
                background-color: var(--header-bg);
                border-radius: 8px;
            }
            .customer-info-left { width: 65%; }
            .customer-info-right { width: 35%; text-align: right; }
            .customer-info strong { font-weight: 500; }
            .items-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
            }
            .items-table th, .items-table td {
                border-bottom: 1px solid var(--border-color);
                padding: 0.5rem;
                text-align: left;
                vertical-align: top;
            }
            .items-table th {
                background-color: var(--header-bg);
                font-weight: 500;
            }
            .col-room { width: 25%; font-weight: 500; }
            .col-item { width: 55%; }
            .col-price { width: 20%; text-align: right; }
            .item-details {
                font-size: 0.9em;
                color: #555;
                padding-left: 0.5rem;
                margin-top: 0.25rem;
            }
            .item-details i { font-style: italic; }
            tr.last-in-room td { border-bottom: 2px solid #CCC; }
            .totals-table {
                width: 50%;
                margin-left: auto;
                border-collapse: collapse;
                margin-top: 1rem;
            }
            .totals-table td {
                padding: 0.5rem;
                border-bottom: 1px solid var(--border-color);
            }
            .text-right { text-align: right; }
            .grand-total { font-weight: 700; font-size: 1.1em; }
            .grand-total td { border-top: 2px solid var(--text-color); border-bottom: 2px solid var(--text-color); }
            .total-text { font-weight: 500; }
            .total-text td { border-bottom: none; }
            footer {
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 1px solid var(--border-color);
                font-size: 9pt;
                display: flex;
                justify-content: space-between;
            }
            .footer-notes { width: 60%; }
            .footer-signature { width: 40%; text-align: center; padding-top: 2rem; }
            .signature-line {
                border-bottom: 1px solid #777;
                width: 80%;
                margin: 0 auto 0.5rem auto;
            }
            /* [NEW] SVG fill-rule for gathered fabric */
            .svg-fabric-gathered {
                fill-rule: evenodd;
            }
        </style>
    </head>
    <body>
        <div class="page">
            <div class="page-header" data-page="1">หน้า 1</div>
            <header>
                ${u}
                <div class="shop-info">
                    <h2>${h}</h2>
                    ${r}<br>
                    เลขประจำตัวผู้เสียภาษี: ${i}<br>
                    ${s}<br>
                    ${n}
                </div>
            </header>

            <div class="customer-info">
                <div class="customer-info-left">
                    <strong>ลูกค้า:</strong> ${L(e.customer_name)||"ลูกค้าเงินสด"}<br>
                    <strong>ที่อยู่:</strong> ${L(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                    <strong>โทร:</strong> ${L(e.customer_phone)||"-"}
                </div>
                <div class="customer-info-right">
                    <strong>วันที่:</strong> ${g}<br>
                    <strong>ยืนราคา:</strong> ${c}<br>
                    <strong>เงื่อนไข:</strong> ${d}
                </div>
            </div>

            <table class="items-table">
                <thead>
                    <tr>
                        <th class="col-room">ห้อง</th>
                        <th class="col-item">รายการ</th>
                        <th class="col-price">ราคา (บาท)</th>
                    </tr>
                </thead>
                <tbody>
                    ${$}
                </tbody>
            </table>

             <table class="totals-table">
                <tbody>
                    ${I}
                </tbody>
            </table>

            <footer>
                <div class="footer-notes">
                    <strong>หมายเหตุ:</strong>
                    <ul>
                        ${p.map(A=>`<li>${L(A)}</li>`).join("")}
                    </ul>
                </div>
                <div class="footer-signature">
                    <div classs="signature-line"></div>
                    (.....................................)<br>
                    ผู้อนุมัติ
                </div>
            </footer>
        </div>
    </body>
    </html>
    `}function $t(e){let o=0,a=[],t=!1,r=!1;if(e.rooms.forEach(c=>{let p=0,u=0,h=0,g=0;c.items.forEach(y=>{const f=v(y.total_price);y.is_suspended?(h+=f,g++):(p+=f,u++)}),(u>0||g>0)&&(u>0&&(o+=p,t=!0),g>0&&(r=!0),a.push({name:L(c.room_name)||"ห้อง (ไม่มีชื่อ)",total:p,itemCount:u,suspendedTotal:h,suspendedCount:g,isSuspended:c.is_suspended}))}),!t&&!r)return'<p class="empty-summary">ไม่มีรายการสำหรับสรุป</p>';const s=a.map(c=>`
        <div class="overview-room ${c.isSuspended?"is-suspended":""}">
            <span class="overview-room-name">${c.name} ${c.isSuspended?"(ระงับทั้งห้อง)":""}</span>
            ${c.itemCount>0?`<span class="overview-room-total">${S(c.total)} <small>(${c.itemCount} รายการ)</small></span>`:""}
            ${c.suspendedCount>0?`<span class="overview-room-suspended">${S(c.suspendedTotal)} <small>(${c.suspendedCount} ระงับ)</small></span>`:""}
        </div>
    `).join(""),n=N.calculateDiscountAmount(o,e.discount),i=o-n,l=e.discount?.value>0?`(${e.discount.type==="percent"?`${e.discount.value}%`:`${S(e.discount.value)} บ.`})`:"";return`
        <div class="overview-summary">
            <div class="overview-total-row">
                <span>ยอดรวม (Subtotal)</span>
                <span>${S(o)}</span>
            </div>
            ${n>0?`
            <div class="overview-total-row is-discount">
                <span>ส่วนลด ${l}</span>
                <span>-${S(n)}</span>
            </div>
            `:""}
            <div class="overview-total-row is-grand-total">
                <span>ยอดสุทธิ (Grand Total)</span>
                <span>${S(i)}</span>
            </div>
        </div>
    `+s}function kt(e){let o=0,a=!1;const t=N.calculateDiscountAmount(e.rooms.reduce((i,l)=>i+(l.is_suspended?0:l.items.reduce((d,c)=>d+(c.is_suspended?0:v(c.total_price)),0)),0),e.discount),r=e.grand_total,s=e.rooms.map(i=>{if(i.is_suspended)return"";const l=i.items.map(d=>{if(d.is_suspended||!d.type)return"";const c=v(d.total_price);c>0&&(o+=c,a=!0);let p="",u="";const h=de[d.type==="set"?d.style==="หลุยส์"?"set_louis":"set":d.type]||"รายการ";switch(d.type){case"set":p=bt(d),u=et(d);break;case"wallpaper":p=Je(d),u=ot(d);break;default:p=Je(d),u=tt(d);break}return`
                <div class="lookbook-item">
                    ${p}
                    <div class="lookbook-item-info">
                        <h5>${L(h)}</h5>
                        <p>${u}</p>
                    </div>
                    <div class="lookbook-item-price">
                        ${c>0?S(c):"ฟรี"}
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return l.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${L(i.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${l}
            </div>
        `:""}).join("");return a?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${L(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${L(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${S(o)} บาท</span>
                ${t>0?`<span>ส่วนลด: -${S(t)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${S(r)} บาท</span>
            </div>
        </div>
    `+s:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}(function(){if(document.getElementById("marnthara-svg-styles"))return;const e=document.createElement("style");e.id="marnthara-svg-styles",e.textContent=`
        /* --- SVG Visual Styles (for LookBook) --- */
        .item-visual {
            width: 100%;
            max-width: 200px;
            margin: 0.5rem auto;
            aspect-ratio: 1 / 1;
            overflow: visible;
        }
        .svg-dim-line { stroke: #888; stroke-width: 0.5; }
        .svg-dim-text { font-size: 5px; fill: #555; text-anchor: middle; dominant-baseline: middle; }
        .svg-fabric { fill: #E0E0E0; stroke: #999; stroke-width: 0.5; }
        /* [NEW] Style for gathered fabric (rod pocket) */
        .svg-fabric-gathered {
            fill-rule: evenodd;
            stroke-width: 0.4;
        }
        .svg-track { fill: #AAA; stroke: #777; stroke-width: 0.2; }
        .svg-rod { fill: #999; stroke: #666; stroke-width: 0.2; border-radius: 1px; }
        .svg-grommet-hole { fill: #FFF; stroke: #888; stroke-width: 0.3; }
        .svg-fold-line { stroke: #BBB; stroke-width: 0.4; }
        .svg-opening-line { stroke: #FFF; stroke-width: 0.5; stroke-dasharray: 2, 1; }
        .svg-blind { fill: #ECECEC; stroke: #AAA; stroke-width: 0.5; }
        .svg-blind-slat { stroke: #BBB; stroke-width: 0.3; }
        .svg-wallpaper { fill: #F0F0F0; stroke: #CCC; stroke-width: 0.5; }
        .svg-wallpaper-pattern { fill: none; stroke: #D0D0D0; stroke-width: 0.4; }
        .svg-louis-valance { fill: #DDC; stroke: #BBA; stroke-width: 0.5; }
        .svg-louis-swag { fill: #EED; stroke: #CCB; stroke-width: 0.5; }
        .svg-default-item { fill: #F5F5F5; stroke: #CCC; stroke-width: 0.5; stroke-dasharray: 2, 2; }
    `,document.head.appendChild(e)})();function rt(e={}){const o=document.querySelector(m.roomTpl);if(!o)return console.error("Room template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1,t.dataset.roomDefaults=JSON.stringify(e.room_defaults||{});const r=t.querySelector(m.roomNameInput),s=t.querySelector("[data-room-name-display]"),n=t.querySelector("[data-room-brief]"),i=t.querySelector(m.allItemsContainer),l=()=>{const p=r.value||"ห้อง (ไม่มีชื่อ)";s&&(s.textContent=p)};r&&r.addEventListener("input",l);const d=t.querySelector("summary");d&&d.addEventListener("click",()=>{});const c=e.room_name||`ห้อง ${document.querySelectorAll(m.room).length+1}`;if(r){r.value=c;const p=`room_name_${t.id}`;r.id=p;const u=r.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",p)}return s&&(s.textContent=c),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>i,t.updateBrief=p=>{n&&(n.innerHTML=p)},t}function Te(e={}){const o=document.querySelector(m.setTpl);if(!o)return console.error("Set template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const r=t.querySelector('input[name="width_m"]'),s=t.querySelector('input[name="height_m"]'),n=t.querySelector('select[name="set_style"]'),i=t.querySelector('select[name="fabric_variant"]'),l=t.querySelector('select[name="set_price_per_m"]'),d=t.querySelector('select[name="sheer_price_per_m"]'),c=t.querySelector('select[name="louis_price_per_m"]'),p=t.querySelector('input[name="fabric_code"]'),u=t.querySelector('input[name="sheer_fabric_code"]'),h=t.querySelector('select[name="opening_style"]'),g=t.querySelector('select[name="adjustment_side"]'),y=t.querySelector('input[name="notes"]'),f=t.querySelector('[data-set-control="opening_style_wrap"]'),_=t.querySelector('[data-set-control="adjustment_side_wrap"]'),w=t.querySelector('[data-set-control="louis_price_wrap"]'),k=t.querySelector('[data-set-control="fabric_price_wrap"]'),x=t.querySelector('[data-set-control="fabric_code_wrap"]'),q=t.querySelector("[data-sheer-wrap]"),$=t.querySelector("[data-sheer-code-wrap]"),T=t.querySelector("[data-set-summary]"),M=t.querySelector(".item-details-more"),I=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,Y=()=>({width_m:r.value,height_m:s.value,style:n.value,fabric_variant:i.value,price_per_m_raw:l.value,sheer_price_per_m:d.value,louis_price_per_m:c.value,is_suspended:t.classList.contains("is-suspended")}),A=()=>{const E=Y(),B=N.calculateSetPrice(E);t.dataset.totalPrice=B.total;let C=`ราคา: <b>${S(B.total)}</b> บ.`;if(E.style==="หลุยส์"){const ee=[];B.opaque>0&&ee.push(`ทึบ: ${S(B.opaque)}`),B.sheer>0&&ee.push(`โปร่ง: ${S(B.sheer)}`),B.louis>0&&ee.push(`หลุยส์: ${S(B.louis)}`),ee.length>0&&(C+=` <small>(${ee.join(", ")})</small>`)}else B.opaque>0&&B.sheer>0&&(C+=` <small>(ทึบ: ${S(B.opaque)}, โปร่ง: ${S(B.sheer)})</small>`);const ae=N.fabricYardage(E.style,E.width_m);ae>0&&(C+=` &bull; ใช้ผ้า: ${ae.toFixed(2)} หลา`),T?T.innerHTML=C:console.warn("Summary element not found for set item.")},z=qe(()=>{A(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),re=()=>{const E=n.value,B=i.value,C=E==="หลุยส์",ae=B.includes("โปร่ง"),ee=B==="โปร่ง"&&!C,pe=B==="ทึบ"&&!C;q?.classList.toggle("hidden",!ae||C),$?.classList.toggle("hidden",!ae||C);const se=ee||C;l&&(l.disabled=se,se&&(l.value="")),p&&(p.disabled=se,se&&(p.value=""));const me=pe||C;d&&(d.disabled=me,me&&(d.value="")),u&&(u.disabled=me,me&&(u.value=""))},ne=()=>{const E=n.value,B=E==="ม่านพับ",C=E==="หลุยส์",ae=B||C||E==="ม่านแป๊บ";f&&f.classList.toggle("hidden",ae),_&&_.classList.toggle("hidden",!B),w&&w.classList.toggle("hidden",!C),k&&k.classList.toggle("hidden",C),x&&x.classList.toggle("hidden",C),re()};t.addEventListener("input",E=>{E.target===i&&re(),E.target===n&&ne(),z()});const Q=E=>{He(E),z()};if(r.addEventListener("blur",Q),s.addEventListener("blur",Q),M&&I){const E=t.querySelector(".item-grid");E&&E.appendChild(I)}return r.value=V(e.width_m),s.value=V(e.height_m),n.value=e.style||"ลอน",i.value=e.fabric_variant||"ทึบ",l.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",c.value=e.louis_price_per_m||"",p.value=e.fabric_code||"",u.value=e.sheer_fabric_code||"",h.value=e.opening_style||"แยกกลาง",g.value=e.adjustment_side||"ปรับขวา",y.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",t.querySelector('input[name="louis_valance"]').value=e.louis_valance||"กล่องหลุยส์",t.querySelector('input[name="louis_tassels"]').value=e.louis_tassels||"สีเข้ากับผ้า",e.is_suspended&&t.classList.add("is-suspended"),ne(),A(),t}function Fe(e={}){const o=document.querySelector(m.wallTpl);if(!o)return null;const t=o.content.cloneNode(!0).firstElementChild,r=t.querySelector('input[name="wall_width_m"]');r.value=V(e.width);const s=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;r.id=s;const n=t.querySelector("label");return n&&n.setAttribute("for",s),t}function Ce(e={}){const o=document.querySelector(m.wallpaperTpl);if(!o)return console.error("Wallpaper template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const r=t.querySelector('[name="wallpaper_height_m"]'),s=t.querySelector('[name="wallpaper_price_roll"]'),n=t.querySelector('[name="wallpaper_install_cost"]'),i=t.querySelector('[name="wallpaper_code"]'),l=t.querySelector('[name="wallpaper_notes"]'),d=t.querySelector("[data-walls-container]"),c=t.querySelector("[data-wallpaper-summary]"),p=t.querySelector(".item-details-more"),u=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,h=()=>({height_m:r.value,price_per_roll:s.value,install_cost_per_roll:n.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(_=>_.value),is_suspended:t.classList.contains("is-suspended")}),g=()=>{const _=h(),w=N.calculateWallpaperPrice(_);t.dataset.totalPrice=w.total;let k=`รวม: <b>${S(w.total)}</b> บ. `;(w.material>0||w.install>0)&&(k+=`<small>(วอลล์: ${S(w.material)}, ค่าช่าง: ${S(w.install)})</small>`),w.rolls>0&&(k+=` &bull; พื้นที่: ${j(w.sqm,2)} ตร.ม. &bull; ใช้: ${w.rolls} ม้วน`),c&&(c.innerHTML=k)},y=qe(()=>{g(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);t.addEventListener("input",y);const f=_=>{He(_),y()};if(r.addEventListener("blur",f),t.addEventListener("blur",_=>{_.target.name==="wall_width_m"&&f(_)},!0),p&&u){const _=t.querySelector(".item-grid");_&&_.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(_=>{const w=Fe({width:_});w&&d.appendChild(w)});else{const _=Fe();_&&d.appendChild(_)}return r.value=V(e.height_m),s.value=e.price_per_roll>0?S(e.price_per_roll):"",e.hasOwnProperty("install_cost_per_roll")?n.value=e.install_cost_per_roll===0?"0":e.install_cost_per_roll>0?S(e.install_cost_per_roll):"":n.value=n.value,i.value=e.wallpaper_code||"",l.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),g(),t}function Be(e,o={}){const a=document.querySelector(m.areaBasedTpl);if(!a)return console.error("AreaBased template not found"),null;const r=a.content.cloneNode(!0).firstElementChild;r.dataset.type=e;const s=J[e]||{name:"ของตกแต่ง"};r.classList.add(`${e.replace(/_/g,"-")}-item`);const n=r.querySelector(".item-type-display"),i=r.querySelector('[name="area_width_m"]'),l=r.querySelector('[name="area_height_m"]'),d=r.querySelector('[name="area_price_sqyd"]'),c=r.querySelector('[name="area_code"]'),p=r.querySelector('[name="area_notes"]'),u=r.querySelector(".btn-favorite"),h=r.querySelector(".btn-show-favs"),g=r.querySelector("[data-area-summary]"),y=r.querySelector(".item-details-more"),f=r.querySelector('[data-act="toggle-more-details"]')?.parentElement,_=y?.querySelector(".item-grid"),w=_?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let k,x;if(_&&w){if(e==="partition"||e==="pleated_screen"){const I=document.createElement("div");I.className="form-group",I.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,_.insertBefore(I,w),k=I.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const I=document.createElement("div");I.className="form-group",I.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,_.insertBefore(I,w),x=I.querySelector("select")}(k||x)&&w&&w.classList.remove("full-width-item")}const q=()=>({width_m:i.value,height_m:l.value,price_sqyd:d.value,is_suspended:r.classList.contains("is-suspended")}),$=()=>{const I=q(),Y=N.calculateAreaBasedPrice(I);r.dataset.totalPrice=Y.total;const A=Y.sqyd>0?` &bull; พื้นที่: ${j(Y.sqyd,2)} ตร.หลา`:"";g&&(g.innerHTML=`ราคา: <b>${S(Y.total)}</b> บ.${A}`)},T=qe(()=>{$(),r.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);r.addEventListener("input",T);const M=I=>{He(I),T()};if(i.addEventListener("blur",M),l.addEventListener("blur",M),y&&f){const I=r.querySelector(".item-grid");I&&I.appendChild(f)}return n&&(n.textContent=s.name),c&&(c.dataset.favoriteType=e),u&&(u.dataset.type=e),h&&(h.dataset.type=e),i.value=V(o.width_m),l.value=V(o.height_m),d.value=o.price_sqyd>0?S(o.price_sqyd):"",c.value=o.code||"",p.value=o.notes||"",k&&(k.value=o.opening_style||"แยกกลาง"),x&&(x.value=o.adjustment_side||"ปรับขวา"),o.is_suspended&&r.classList.add("is-suspended"),$(),r}const R=[];let G=!1,ke=null,D=null,ye=null,we=!1,F=null,Ee=!1,ie=null,ue=null,le=[];const ze=document.querySelector("#undoBtn"),Oe="marnthara.theme",Me={};function Mt(e){if(Me[e])return Me[e];const o=new Promise((a,t)=>{const r=document.createElement("script");r.src=e,r.onload=()=>a(),r.onerror=()=>{console.error(`Script load error for ${e}`),delete Me[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(r)});return Me[e]=o,o}function at(){const e=localStorage.getItem(Oe),o=document.querySelector("#themeToggleBtn");if(!o)return;const a=o.querySelector("i"),t=o.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),a&&(a.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),a&&(a.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:a&&(a.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function Lt(){const e=localStorage.getItem(Oe);let o="neutral";!e||e==="light"?o="neutral":e==="neutral"?o="dark":o="light",localStorage.setItem(Oe,o),at()}function U(){ze&&(ze.disabled=!gt())}function xt(){const e=_t();e&&(Ve(e,!1),b("ยกเลิกการกระทำล่าสุดแล้ว","success")),U()}function ve(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ye){e.classList.remove("is-visible");return}const o=document.getElementById("suspendedCountBadge"),a=document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length,t=document.querySelectorAll(".room-card.is-suspended");let r=0;t.forEach(n=>{r+=n.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").length});const s=a+r;o&&(o.textContent=s),e.classList.toggle("is-visible",s>0)}function De(){ye="suspended";const e=document.getElementById("filterStatusBar");let o=0;if(document.querySelectorAll(".room-card").forEach(t=>{let r=!1;const s=t.classList.contains("is-suspended");t.querySelectorAll(".item-card").forEach(i=>{const d=i.classList.contains("is-suspended")||s;i.classList.toggle("item-hidden",!d),d&&(r=!0,i.classList.contains("placeholder-item")||o++)});const n=s||r;t.classList.toggle("item-hidden",!n)}),document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length+Array.from(document.querySelectorAll(".room-card.is-suspended .item-card:not(.is-suspended):not(.placeholder-item)")).length===0){st(),b("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${o} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),X(),Z(),ve()}function It(e,o){if(!e)return;ye=e;const a=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(m.room).forEach(r=>{let s=0;r.querySelectorAll(".item-card").forEach(n=>{const i=n.dataset.type===e&&!n.classList.contains("placeholder-item");n.classList.toggle("item-hidden",!i),i&&s++}),r.querySelectorAll(".placeholder-item").forEach(n=>n.classList.toggle("item-hidden",s===0)),r.classList.toggle("item-hidden",s===0),s>0&&(t+=s)}),a&&(a.innerHTML=`
            <span>เฉพาะ: <strong>${L(o)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,a.classList.add("is-visible"),a.dataset.filterType=e),X(),Z(),ve()}function st(){ye=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(o=>o.classList.remove("item-hidden")),X(),Z(),ve()}function b(e,o="default"){const a=document.querySelector(m.toastContainer);if(!a)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},r=document.createElement("div");r.className=`toast toast-${o}`,r.innerHTML=`<i class="${t[o]||t.default}"></i> ${L(e)}`,a.appendChild(r),setTimeout(()=>r.classList.add("show"),10),setTimeout(()=>{r.classList.remove("show"),r.addEventListener("transitionend",()=>r.remove())},3e3)}function P(e,o){return new Promise(a=>{const t=document.querySelector(e);if(!t){console.error("Modal not found:",e),a(null);return}if(R.length>0){const u=R[R.length-1];u&&u.classList.contains("visible")&&u.classList.add("is-underlay")}R.push(t),t.classList.add("visible");const r=t.querySelector('[id$="Confirm"]'),s=t.querySelector('[id$="Cancel"], [data-act="close-modal"], #roomDefaultsCancelBtn, #manageFavsTypeCancel, #forceApplyCancel, #forceApplyTypeCancel, #dimensionEntryCancel'),n=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),i=n[0],l=n[n.length-1];setTimeout(()=>i?.focus(),50);const d=u=>{t.classList.remove("visible"),document.removeEventListener("keydown",c),t.removeEventListener("click",p),r&&(r.onclick=null),s&&(s.onclick=null),t.closeModal===d&&(t.closeModal=null);const h=R.pop();h!==t&&(console.error(`[cleanup] Modal stack mismatch! Expected #${t.id}, but popped #${h?.id}. Resetting stack.`),R.length=0);const g=R.length>0?R[R.length-1]:null;g&&g.classList.contains("visible")&&g.classList.remove("is-underlay"),e==="#roomDefaultsModal"&&(le.forEach(({element:y,event:f,handler:_})=>{y.removeEventListener(f,_)}),le=[],ue=null),e==="#favoritesModal"&&(ie=null),u?.cancelled&&typeof o=="function"&&o(),a(u)};t.closeModal=d;const c=u=>{const h=R.length>0&&R[R.length-1]===t;u.key==="Escape"&&h&&d({cancelled:!0}),u.key==="Tab"&&n.length>1&&(u.shiftKey?document.activeElement===i&&(l.focus(),u.preventDefault()):document.activeElement===l&&(i.focus(),u.preventDefault()))},p=u=>{const h=R.length>0&&R[R.length-1]===t;u.target===t&&h&&(u.stopPropagation(),d({cancelled:!0}))};r&&(r.onclick=()=>d(!0)),s&&(s.onclick=()=>{R.length>0&&R[R.length-1]===t&&d({cancelled:!0})}),document.addEventListener("keydown",c),t.addEventListener("click",p)})}async function K(e,o){const a=document.querySelector(m.modal);return a?(a.querySelector(m.modalTitle).textContent=e,a.querySelector(m.modalBody).textContent=o,await P(m.modal)===!0):!0}async function Tt(){const e=document.querySelector(m.exportOptionsModal);if(!e)return null;const o=e.querySelector("#pageBreakBuffer"),a=e.querySelector("#pageBreakBufferValue");o&&a&&(a.textContent=o.value,o.oninput=()=>{a.textContent=o.value});const t=await P(m.exportOptionsModal);return o&&(o.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",showDetails:(e.querySelector('input[name="item_details_option"]:checked')?.value||"show_details")==="show_details",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(o?.value,10)||3}}async function Ct(){const e=document.querySelector("#discountModal");if(!e)return Promise.resolve({cancelled:!0});const o=e.querySelector("#discountSubtotal"),a=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),r=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),i=v(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);o&&(o.textContent=S(i));const l=f=>{if(Ee)return;Ee=!0;let _=0;if(f==="percent"){const w=v(a.value);_=i*(Math.max(0,w)/100),t.value=_>0?S(Math.round(_)):""}else _=v(t.value);if(_=Math.max(0,Math.min(_,i)),f!=="percent"){const w=i>0?_/i*100:0;a.value=w>0&&isFinite(w)?j(w,2):""}r&&(r.textContent=S(i-_)),setTimeout(()=>{Ee=!1},50)},d=()=>l("percent"),c=()=>l("amount"),p=f=>{v(f.target.value)>0&&(f.target.value=v(f.target.value))},u=f=>{const _=v(f.target.value);f.target.value=_>0?S(_):"",l("amount")};a.addEventListener("input",d),t.addEventListener("input",c),t.addEventListener("focus",p),t.addEventListener("blur",u);const h=s.value,g=v(n.value);a.value="",t.value="",g>0?h==="percent"?(a.value=g,l("percent")):(t.value=g,t.value=S(g),l("amount")):l();const y=await P("#discountModal");if(a.removeEventListener("input",d),t.removeEventListener("input",c),t.removeEventListener("focus",p),t.removeEventListener("blur",u),y&&!y.cancelled){const f=v(a.value),_=v(t.value),w=document.activeElement;f>0&&w===a?(s.value="percent",n.value=f):_>0?(s.value="amount",n.value=_):f>0?(s.value="percent",n.value=f):(s.value="amount",n.value=0),H()}}async function Bt(){if(!D)return;const e=document.querySelector("#hardwareModal");if(!e)return;const o=D.querySelector('[name="set_style"]'),a=o?o.value:null,t=a==="ตาไก่",r=a==="ม่านพับ",s=a==="หลุยส์",n=e.querySelector("#trackColorGroup"),i=e.querySelector("#bracketColorGroup"),l=e.querySelector("#finialColorGroup"),d=e.querySelector("#grommetColorGroup"),c=e.querySelector("#louisValanceGroup"),p=e.querySelector("#louisTasselGroup"),u=e.querySelector("#hardwareApplyToRoom");e.querySelector('[name="modal_track_color"]').value=D.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=D.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=D.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=D.querySelector('[name="grommet_color"]')?.value||"เงิน",e.querySelector('[name="modal_louis_valance"]').value=D.querySelector('[name="louis_valance"]')?.value||"กล่องหลุยส์",e.querySelector('[name="modal_louis_tassels"]').value=D.querySelector('[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",n&&(n.style.display=""),i&&(i.style.display=""),l&&(l.style.display=t?"":"none"),d&&(d.style.display=t?"":"none"),c&&(c.style.display=s?"":"none"),p&&(p.style.display=s?"":"none"),u&&(u.disabled=r||s);const h=await P("#hardwareModal");h&&!h.cancelled&&(D.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,D.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t?(D.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,D.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value):s&&(D.querySelector('[name="louis_valance"]').value=e.querySelector('[name="modal_louis_valance"]').value,D.querySelector('[name="louis_tassels"]').value=e.querySelector('[name="modal_louis_tassels"]').value),W(),b("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),D=null}async function At(e){if(!e)return;ue=e;const o=document.querySelector(m.roomDefaultsModal),a=document.querySelector(m.roomDefaultsForm);if(!o||!a)return;le.forEach(({element:l,event:d,handler:c})=>{l.removeEventListener(d,c)}),le=[];const t=JSON.parse(ue.dataset.roomDefaults||"{}"),r=o.querySelectorAll(".defaults-tab"),s=o.querySelectorAll(".defaults-content"),n=l=>{const d=l.currentTarget,c=d.dataset.target;if(!c)return;r.forEach(u=>u.classList.remove("is-active")),s.forEach(u=>u.classList.remove("is-active")),d.classList.add("is-active");const p=o.querySelector(`.defaults-content[data-type="${c}"]`);p&&p.classList.add("is-active")};r.forEach(l=>{l.addEventListener("click",n),le.push({element:l,event:"click",handler:n})}),r[0]&&r[0].classList.add("is-active"),s[0]&&s[0].classList.add("is-active");const i=l=>{const d=l.target,c=d.closest(".defaults-content");if(!c)return;const p=d.checked,u=c.querySelector(".defaults-inputs-grid");c.classList.toggle("is-enabled-content",p),u&&u.querySelectorAll('input[type="text"], input[type="number"], select, .btn-show-favs').forEach(h=>{h.disabled=!p,h.matches(".btn-show-favs")&&(h.style.opacity=p?"1":"0.5",h.style.pointerEvents=p?"auto":"none")})};s.forEach(l=>{const d=l.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(!d)return;const c=d.name,p=t[c]===!0||t[c]==="1";d.checked=p,i({target:d}),d.addEventListener("change",i),le.push({element:d,event:"change",handler:i});const u=l.querySelector(".defaults-inputs-grid");u&&u.querySelectorAll('input[type="text"], input[type="number"]').forEach(h=>{const g=h.name,y=t[g];h.type==="text"&&h.inputMode==="numeric"?(h.value=y===0?"0":y!=null&&y>0?S(y):"",h.addEventListener("focus",Qe),h.addEventListener("blur",Ke),le.push({element:h,event:"focus",handler:Qe}),le.push({element:h,event:"blur",handler:Ke})):h.value=y||""})}),await P(m.roomDefaultsModal)}async function Et(){const e=document.querySelector("#forceApplyModal");if(!e)return;const o=e.querySelector('[name="force_apply_type_hidden"]'),a=e.querySelector("#forceApplySelectedTypeDisplay"),t=e.querySelector('[name="force_apply_code"]'),r=e.querySelector('[name="force_apply_price"]'),s=t?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs");o&&(o.value=""),a&&(a.textContent="-- เลือกประเภท --"),t&&(t.value="",t.dataset.favoriteType=""),r&&(r.value=""),s&&(s.disabled=!0),await P("#forceApplyModal")}function Qe(e){e.target.value!=="0"&&v(e.target.value)>0&&(e.target.value=v(e.target.value))}function Ke(e){const o=v(e.target.value);e.target.value=o===0?"0":o!=null&&o>0?S(o):""}function Dt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsForm);if(!e)return;const o={};e.querySelectorAll(".defaults-content").forEach(t=>{const r=t.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(r){const s=r.name,n=r.checked;if(o[s]=n,n){const i=t.querySelector(".defaults-inputs-grid");i&&i.querySelectorAll('input[type="text"], input[type="number"]').forEach(l=>{const d=l.name,c=l.value.trim();let p;l.type==="text"&&l.inputMode==="numeric"?c===""?p=void 0:p=v(c):p=c,(typeof p=="number"&&!isNaN(p)||typeof p=="string"&&p!=="")&&(o[d]=p)})}}}),ue.dataset.roomDefaults=JSON.stringify(o),W();const a=document.querySelector(m.roomDefaultsModal);a&&typeof a.closeModal=="function"?(a.closeModal(!0),setTimeout(()=>b("บันทึกค่าเริ่มต้นห้องแล้ว","success"),50)):console.error("Could not find room defaults modal or its closer function.")}async function Pt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsModal),o=document.querySelector(m.roomDefaultsForm);if(!e||!o)return;const a={};if(o.querySelectorAll(".defaults-content").forEach(s=>{const n=s.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(n&&n.checked){const i=s.querySelector(".defaults-inputs-grid");i&&i.querySelectorAll('input[type="text"], input[type="number"]').forEach(l=>{const d=l.name,c=l.type==="text"&&l.inputMode==="numeric"?v(l.value):l.value.trim();(typeof c=="number"&&!isNaN(c)||typeof c=="string"&&c!=="")&&(a[d]=c)})}}),Object.keys(a).length===0){b("ยังไม่มีการเลือกค่าเริ่มต้นที่จะใช้","warning");return}if(!await K("ใช้ค่าเริ่มต้น","ใช้ค่าเริ่มต้นที่ *เลือกไว้* กับรายการที่ยังไม่มีข้อมูลในห้องนี้?"))return;oe(O()),U();let t=0;ue.getItemsContainer().querySelectorAll(".item-card").forEach(s=>{const n=s.dataset.type;let i=!1;const l=(d,c)=>{const p=a[c],u=s.querySelector(d);if(!u||p==null)return;const h=u.tagName==="SELECT",g=h?u.value:u.value.trim(),y=h?null:v(g);let f=!1;if(h?f=!g:u.matches('input[type="text"][inputmode="numeric"]')?f=!g||y===0:f=!g,f){let _=!1;h?Array.from(u.options).some(w=>w.value==p)&&(u.value=p,_=!0):u.matches('input[type="text"][inputmode="numeric"]')?typeof p=="number"&&!isNaN(p)&&(u.value=p===0?"0":S(p),_=!0):u.matches('input[type="text"]:not([inputmode])')&&(u.value=p,_=!0),_&&(i=!0,u.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),u.matches('input[type="text"][inputmode="numeric"]')&&u.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})))}};switch(n){case"set":l(m.setFabricCodeInput,"defaults_fabric_code"),l(m.setPricePerMSelect,"defaults_fabric_price"),l(m.setSheerCodeInput,"defaults_sheer_code"),l(m.setSheerPricePerMSelect,"defaults_sheer_price");break;case"wallpaper":l(m.wallCodeInput,"defaults_wallpaper_code"),l(m.wallPriceRollInput,"defaults_wallpaper_price_roll"),l(m.wallInstallCostInput,"defaults_wallpaper_install_cost");break;case"wooden_blind":l(m.areaCodeInput,"defaults_wooden_blind_code"),l(m.areaPriceSqydInput,"defaults_wooden_blind_price_sqyd");break;case"roller_blind":l(m.areaCodeInput,"defaults_roller_blind_code"),l(m.areaPriceSqydInput,"defaults_roller_blind_price_sqyd");break;case"vertical_blind":l(m.areaCodeInput,"defaults_vertical_blind_code"),l(m.areaPriceSqydInput,"defaults_vertical_blind_price_sqyd");break;case"partition":l(m.areaCodeInput,"defaults_partition_code"),l(m.areaPriceSqydInput,"defaults_partition_price_sqyd");break;case"pleated_screen":l(m.areaCodeInput,"defaults_pleated_screen_code"),l(m.areaPriceSqydInput,"defaults_pleated_screen_price_sqyd");break;case"aluminum_blind":l(m.areaCodeInput,"defaults_aluminum_blind_code"),l(m.areaPriceSqydInput,"defaults_aluminum_blind_price_sqyd");break}i&&t++}),e&&typeof e.closeModal=="function"?e.closeModal({cancelled:!0}):console.error("Could not find room defaults modal or its closer function."),setTimeout(()=>{t>0?(H(),b(`ใช้ค่าเริ่มต้นกับ ${t} รายการแล้ว`,"success")):b("ไม่มีรายการใดที่ต้องอัปเดต","default")},50)}async function Nt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const o=e.querySelector('[name="force_apply_type_hidden"]'),a=e.querySelector('[name="force_apply_code"]'),t=e.querySelector('[name="force_apply_price"]'),r=o.value,s=a.value.trim(),n=v(t.value);if(!r){b("โปรดเลือกประเภทรายการที่จะบังคับใช้","warning"),e.querySelector("#forceApplySelectTypeBtn")?.focus();return}if(!s){b("โปรดกรอกรหัสที่จะบังคับใช้","warning"),a.focus();return}if(n<0||n<=0&&!["fabric","sheer","wallpaper"].includes(r)){b("โปรดกรอกราคาที่ถูกต้อง (> 0)","warning"),t.focus();return}const i=e.querySelector("#forceApplySelectedTypeDisplay");let l=i?i.textContent:r;const d="ยืนยันการบังคับใช้",c=`⚠️ ยืนยันการเปลี่ยนรหัสเป็น "${s}" และราคาเป็น ${S(n)} บาท สำหรับรายการประเภท "${l}" ***ทุกรายการ*** ในทุกห้องหรือไม่? การกระทำนี้ไม่สามารถยกเลิกได้ง่ายๆ`;if(!await K(d,c))return;oe(O()),U();let p=0;document.querySelectorAll(".item-card").forEach(h=>{if(h.classList.contains("placeholder-item"))return;const g=h.dataset.type;let y=null,f=null;if(r==="fabric"&&g==="set"?(y=h.querySelector('input[name="fabric_code"]'),f=h.querySelector('select[name="set_price_per_m"]')):r==="sheer"&&g==="set"?(y=h.querySelector('input[name="sheer_fabric_code"]'),f=h.querySelector('select[name="sheer_price_per_m"]')):r==="wallpaper"&&g==="wallpaper"?(y=h.querySelector('input[name="wallpaper_code"]'),f=h.querySelector('input[name="wallpaper_price_roll"]')):g===r&&h.matches(".area-based-item")&&(y=h.querySelector('input[name="area_code"]'),f=h.querySelector('input[name="area_price_sqyd"]')),y&&f){if(y.value=s,y.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),f.tagName==="SELECT")if(Array.from(f.options).some(w=>w.value==n))f.value=n;else{if(console.warn(`Price ${n} not found in options for`,f,". Forcing new option."),!f.querySelector(`option[value="${n}"][data-forced="true"]`)){const k=document.createElement("option");k.value=n,k.textContent=n===0?"0 บาท":`${S(n)} บาท (บังคับ)`,k.dataset.forced="true",f.appendChild(k)}f.value=n}else{const _=n===0?"0":n!=null&&n>0?S(n):"";f.value=_}f.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),f.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),p++,y.classList.add("input-highlight"),f.classList.add("input-highlight"),setTimeout(()=>{y.classList.remove("input-highlight"),f.classList.remove("input-highlight")},1200)}}),p>0?(H(),b(`บังคับใช้ค่าใหม่กับ ${p} รายการ (${l}) สำเร็จ`,"success"),e&&typeof e.closeModal=="function"&&e.closeModal({cancelled:!0})):b(`ไม่พบรายการประเภท "${l}" ที่ต้องอัปเดต`,"default")}async function Rt(){const e=document.querySelector("#manageFavsTypeModal"),o=document.querySelector("#manageFavsTypeBody");if(!e||!o)return;const a=Object.keys(ce());let t="",r=null;const s={fabric:"ph-rows",sheer:"ph-waves",wallpaper:"ph-paint-roller",wooden_blind:"ph-table",roller_blind:"ph-scroll",vertical_blind:"ph-sidebar-simple",partition:"ph-columns",pleated_screen:"ph-squares-four",aluminum_blind:"ph-stack-simple"};if(a.includes("fabric")&&(t+=`
             <label data-item-type="fabric">
                 <input type="radio" name="manage_fav_type_option" value="fabric">
                 <span class="radio-card-content">
                     <strong><i class="ph ${s.fabric}"></i> ผ้าทึบ</strong>
                     <small>Fabric Codes</small>
                 </span>
             </label>`,r||(r="fabric")),a.includes("sheer")&&(t+=`
              <label data-item-type="sheer">
                  <input type="radio" name="manage_fav_type_option" value="sheer">
                  <span class="radio-card-content">
                      <strong><i class="ph ${s.sheer}"></i> ผ้าโปร่ง</strong>
                      <small>Sheer Codes</small>
                  </span>
              </label>`,r||(r="sheer")),a.forEach(i=>{if(i==="fabric"||i==="sheer")return;const l=J[i];if(l){const d=l.name,c=s[i]||"ph-star";t+=`
                <label data-item-type="${i}">
                    <input type="radio" name="manage_fav_type_option" value="${i}">
                    <span class="radio-card-content">
                        <strong><i class="ph ${c}"></i> ${L(d)}</strong>
                        <small>${i.replace(/_/g," ").replace(/\b\w/g,p=>p.toUpperCase())} Codes</small>
                    </span>
                </label>`,r||(r=i)}}),o.innerHTML=t,r){const i=o.querySelector(`input[value="${r}"]`);i&&(i.checked=!0)}const n=await P("#manageFavsTypeModal");if(n&&!n.cancelled){const i=o.querySelector('input[name="manage_fav_type_option"]:checked')?.value;i&&await it(i)}}function Pe(e,o){e&&(oe(O()),U(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),b(o),Ae(),X(),H(),$e()},{once:!0}))}function Ft(e){if(!e)return;const o=document.querySelector(".main-header");if(!o){e.scrollIntoView({behavior:"smooth",block:"center"});return}const a=o.offsetHeight,t=16,s=(e.querySelector(".item-header")||e).getBoundingClientRect(),n=a+t,i=s.top-n;Math.abs(i)>5&&window.scrollBy({top:i,behavior:"smooth"})}function _e(e){if(!e)return;const o=document.querySelector(".main-header"),a=document.querySelector(".summary-footer"),t=o?o.offsetHeight+16:80,r=a?a.offsetHeight+16:100;requestAnimationFrame(()=>{const s=e.getBoundingClientRect(),n=window.innerHeight;if(!(s.top>=t&&s.bottom<=n-r)){const l=n-t-r,d=s.height>l?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function X(){document.querySelectorAll(m.room).forEach(e=>{const o=e.querySelectorAll(".item-card:not(.item-hidden)");let a=0;const t=Array.from(o).filter(r=>!r.classList.contains("is-suspended")&&!r.classList.contains("placeholder-item")).length;o.forEach(r=>{const s=r.querySelector("[data-item-title]");s&&(r.classList.contains("placeholder-item")?s.textContent="...":r.classList.contains("is-suspended")?s.textContent="-":(a++,s.textContent=`${a}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(r=>{const s=r.querySelector("[data-item-title]");s&&(s.textContent="-")})})}function nt(){const e=document.querySelector(m.orderForm),o=document.querySelector(m.lockBtn);!e||!o||(e.classList.toggle("is-locked",G),o.classList.toggle("is-locked",G),o.querySelector("i").className=G?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(a=>{!a.closest(".main-header")&&!a.closest(".summary-footer")&&!a.closest(".modal-wrapper")&&(a.disabled=G)}),document.querySelectorAll(".unlockable").forEach(a=>a.disabled=!1))}function Ot(){G=!G,nt(),b(G?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",G?"warning":"success")}function Z(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(m.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const o=[...e].some(t=>t.open),a=document.querySelector(m.toggleAllRoomsBtn);a&&(a.querySelector("i").className=o?"ph ph-caret-up":"ph ph-caret-down",a.querySelector("span").textContent=o?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Ht(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0)return;const o=[...e].some(t=>t.open);e.forEach(t=>{t.open=!o});const a=document.querySelector(m.quickNavDropdown);a&&a.classList.contains("show")&&(a.classList.remove("show"),document.querySelector(m.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{Z(),W()},50)}function Ae(){const e=document.querySelector(m.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(m.room).forEach(o=>{const a=o.querySelector(m.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${o.id}`,t.dataset.jumpTo=o.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${L(a)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Ne(e){const o=document.getElementById("quickNavBtnText");o&&(e?o.textContent=e.querySelector('input[name="room_name"]')?.value||"...":o.textContent="ไปยังห้อง")}function $e(){if(ke&&ke.disconnect(),!document.getElementById("quickNavBtnText"))return;const o={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},a=r=>{const s=r.filter(n=>n.isIntersecting).sort((n,i)=>n.target.getBoundingClientRect().top-i.target.getBoundingClientRect().top);s.length>0&&Ne(s[0].target)};ke=new IntersectionObserver(a,o),document.querySelectorAll(m.room).forEach(r=>ke.observe(r));const t=Array.from(document.querySelectorAll(m.room));if(t.length>0){t.sort((s,n)=>s.getBoundingClientRect().top-n.getBoundingClientRect().top);const r=t.find(s=>s.getBoundingClientRect().bottom>60);Ne(r||t[0])}else Ne(null)}function Le(e,o=null){if(!e||e.classList.contains("placeholder-item"))return;const a=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),r=t?.parentElement;if(!a||!t||!r)return;const s=a.classList.contains("show"),n=o!==null?o:!s;if(s===n)return;a.classList.toggle("show",n),t.classList.toggle("expanded",n);const i=t.querySelector("i");i&&(i.className=n?"ph ph-caret-up":"ph ph-caret-down");const l=t.querySelector("span");if(l&&(l.textContent=n?"ย่อน้อยลง":"เพิ่มเติม"),n)a.appendChild(r),setTimeout(()=>Ft(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(r)}}function he(e={}){const o=document.querySelector(m.roomsContainer);if(!o)return null;Object.keys(e).length===0&&(oe(O()),U());const a=rt(e);return a?(o.appendChild(a),Object.keys(e).length===0&&(a.classList.add("item-created"),_e(a),a.querySelector('input[name="room_name"]')?.focus()),Ae(),Z(),$e(),Object.keys(e).length===0&&W(),a):null}async function lt(e,o=null){const a=document.querySelector("#itemTypeModal");if(!a)return null;a.querySelector("#itemTypeModalTitle").textContent=e;let t=o||"set";o&&!J[o]&&(t="set");const r=a.querySelector(`input[name="item_type_option"][value="${t}"]`);if(r)r.checked=!0;else{const i=a.querySelector('input[name="item_type_option"][value="set"]');i&&(i.checked=!0)}const s=await P("#itemTypeModal");if(!s||s.cancelled)return null;const n=a.querySelector('input[name="item_type_option"]:checked');return n?n.value:null}function Xe(){const e=document.createElement("div");return e.className="dimension-input-row",e.innerHTML=`
        <div class="form-group">
            <label class="visually-hidden">กว้าง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_width_m" placeholder="กว้าง">
        </div>
        <div class="form-group">
            <label class="visually-hidden">สูง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_height_m" placeholder="สูง">
        </div>
        <button type="button" class="btn-icon btn-icon-small danger btn-remove-dimension-row" data-act="remove-dimension-row" title="ลบขนาด" aria-label="ลบขนาดแถวนี้"><i class="ph-bold ph-x"></i></button>
    `,e.querySelectorAll('input[type="number"]').forEach(o=>{o.addEventListener("blur",a=>{a.target.value=V(a.target.value)})}),e}function jt(e,o){if(!o||!e||e.width_m<=0||e.height_m<=0)return;const a=o.getItemsContainer();if(!a)return;const t=document.querySelector("#placeholderItemTpl");if(!t)return console.error("Placeholder template not found"),null;const s=t.content.cloneNode(!0).firstElementChild;s.dataset.widthM=e.width_m,s.dataset.heightM=e.height_m;const n=s.querySelector("[data-placeholder-width]"),i=s.querySelector("[data-placeholder-height]");return n&&(n.textContent=V(e.width_m)),i&&(i.textContent=V(e.height_m)),a.appendChild(s),s.classList.add("item-created"),s}function Vt(e,o,a){if(!e||!o||!a)return;const t=e.closest(m.room);if(!t)return;oe(O()),U();const r=JSON.parse(t.dataset.roomDefaults||"{}");let s={width_m:a.width_m,height_m:a.height_m};const n=l=>r[`enable_defaults_${l}`]===!0;switch(o){case"set":n("set")&&(s.fabric_code=r.defaults_fabric_code,s.price_per_m_raw=r.defaults_fabric_price,s.sheer_fabric_code=r.defaults_sheer_code,s.sheer_price_per_m=r.defaults_sheer_price);break;case"wallpaper":n("wallpaper")&&(s.wallpaper_code=r.defaults_wallpaper_code,s.price_per_roll=r.defaults_wallpaper_price_roll,s.install_cost_per_roll=r.defaults_wallpaper_install_cost),delete s.width_m;break;case"wooden_blind":n("wooden_blind")&&(s.code=r.defaults_wooden_blind_code,s.price_sqyd=r.defaults_wooden_blind_price_sqyd);break;case"roller_blind":n("roller_blind")&&(s.code=r.defaults_roller_blind_code,s.price_sqyd=r.defaults_roller_blind_price_sqyd);break;case"vertical_blind":n("vertical_blind")&&(s.code=r.defaults_vertical_blind_code,s.price_sqyd=r.defaults_vertical_blind_price_sqyd);break;case"partition":n("partition")&&(s.code=r.defaults_partition_code,s.price_sqyd=r.defaults_partition_price_sqyd);break;case"pleated_screen":n("pleated_screen")&&(s.code=r.defaults_pleated_screen_code,s.price_sqyd=r.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":n("aluminum_blind")&&(s.code=r.defaults_aluminum_blind_code,s.price_sqyd=r.defaults_aluminum_blind_price_sqyd);break}let i;if(o==="set")i=Te(s);else if(o==="wallpaper")i=Ce(s);else if(J[o]?.templateId==="#areaBasedTpl")i=Be(o,s);else{b(`ไม่รู้จักประเภทรายการ: ${o}`,"error");return}i&&(e.replaceWith(i),i.classList.add("item-created"),_e(i),i.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),X(),H(),b(`เพิ่ม ${J[o]?.name||"รายการ"} แล้ว`,"success"))}async function Wt(e){if(!e||e.classList.contains("placeholder-item"))return;const o=e.dataset.type,a=await lt("เปลี่ยนประเภทรายการ",o);if(!a||a===o||!await K("ยืนยันการเปลี่ยนแปลง","ข้อมูลส่วนใหญ่ในรายการนี้จะถูกล้างและใช้ค่าเริ่มต้น (ถ้ามี) คุณแน่ใจหรือไม่?"))return;oe(O()),U();const t={width_m:v(e.querySelector('input[name$="_width_m"], input[name="width_m"]')?.value),height_m:v(e.querySelector('input[name$="_height_m"], input[name="height_m"]')?.value)};o==="wallpaper"&&(t.height_m=v(e.querySelector(m.wallHeightInput)?.value));const r=e.closest(m.room),s=JSON.parse(r?.dataset.roomDefaults||"{}");let n={width_m:t.width_m>0?t.width_m:void 0,height_m:t.height_m>0?t.height_m:void 0};const i=d=>s[`enable_defaults_${d}`]===!0;switch(a){case"set":i("set")&&(n.fabric_code=s.defaults_fabric_code,n.price_per_m_raw=s.defaults_fabric_price,n.sheer_fabric_code=s.defaults_sheer_code,n.sheer_price_per_m=s.defaults_sheer_price);break;case"wallpaper":i("wallpaper")&&(n.wallpaper_code=s.defaults_wallpaper_code,n.price_per_roll=s.defaults_wallpaper_price_roll,n.install_cost_per_roll=s.defaults_wallpaper_install_cost),delete n.width_m,n.height_m=t.height_m>0?t.height_m:void 0;break;case"wooden_blind":i("wooden_blind")&&(n.code=s.defaults_wooden_blind_code,n.price_sqyd=s.defaults_wooden_blind_price_sqyd);break;case"roller_blind":i("roller_blind")&&(n.code=s.defaults_roller_blind_code,n.price_sqyd=s.defaults_roller_blind_price_sqyd);break;case"vertical_blind":i("vertical_blind")&&(n.code=s.defaults_vertical_blind_code,n.price_sqyd=s.defaults_vertical_blind_price_sqyd);break;case"partition":i("partition")&&(n.code=s.defaults_partition_code,n.price_sqyd=s.defaults_partition_price_sqyd);break;case"pleated_screen":i("pleated_screen")&&(n.code=s.defaults_pleated_screen_code,n.price_sqyd=s.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":i("aluminum_blind")&&(n.code=s.defaults_aluminum_blind_code,n.price_sqyd=s.defaults_aluminum_blind_price_sqyd);break}let l;if(a==="set")l=Te(n);else if(a==="wallpaper")l=Ce(n);else if(J[a]?.templateId==="#areaBasedTpl")l=Be(a,n);else return;l&&(e.replaceWith(l),l.classList.add("item-created"),_e(l),l.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),X(),H(),b("เปลี่ยนประเภทรายการแล้ว","success"))}const H=qe(()=>{let e=0;document.querySelectorAll(m.room).forEach(d=>{let c=0,p=0;const u=d.classList.contains("is-suspended");if(u||(d.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").forEach(h=>{const g=v(h.dataset.totalPrice);g>0&&(c+=g,p++)}),e+=c),typeof d.updateBrief=="function"){const h=d.querySelectorAll(".placeholder-item:not(.is-suspended)").length;if(u)d.updateBrief("(ระงับชั่วคราว)");else if(p>0){let g=`<span>${p}</span> &bull; ${S(c)} บาท`;h>0&&(g+=` (+${h} รอเลือก)`),d.updateBrief(g)}else h>0?d.updateBrief(`<span>${h}</span> รอเลือกประเภท`):d.updateBrief("<span>0</span> รายการ")}});const o=document.querySelector("#discount_type"),a=document.querySelector("#discount_value"),t=o?o.value:"amount",r=a?v(a.value):0;let s=0;r>0&&(s=t==="percent"?e*(r/100):r,s=Math.min(e,s));const n=e-s,i=document.querySelector("#grandTotal"),l=document.querySelector("#originalTotal");i&&(i.textContent=S(n)),l&&(s>0?(l.textContent=S(e),l.dataset.rawTotal=e,l.style.display="block"):(l.style.display="none",l.dataset.rawTotal="")),ve(),W()},200);async function Ve(e,o=!1){if(!e){b("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(o){const d=document.querySelector("#favoritesConflictModal");if(d){const c=d.querySelector('input[name="fav_conflict_option"][value="merge"]');c&&(c.checked=!0);const p=await P("#favoritesConflictModal");if(!p||p.cancelled){b("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let h=0;switch(u){case"overwrite":Ge(e.favorites)&&b("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":h=Re(e.favorites),b(`รวมข้อมูลสำเร็จ (เพิ่ม ${h} รายการใหม่)`,"success");break;case"skip":b("ข้ามการนำเข้ารายการโปรด","default");break}}else Re(e.favorites)}else Ge(e.favorites);const a=document.querySelector(m.roomsContainer);if(!a)return;a.innerHTML="";const t=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),s=document.querySelector("#customer_address"),n=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),r&&(r.value=e.customer_phone||""),s&&(s.value=e.customer_address||""),n&&(n.open=e.customer_card_open??!0);const i=document.querySelector("#discount_type"),l=document.querySelector("#discount_value");if(e.discount&&i&&l?(i.value=e.discount.type||"amount",l.value=e.discount.value||0):i&&l&&(i.value="amount",l.value=0),!Array.isArray(e.rooms)){b("ไม่พบข้อมูลห้องในไฟล์","warning"),a.children.length===0&&he();return}for(const d of e.rooms){const c=rt(d);if(!c)continue;a.appendChild(c);const p=c.getItemsContainer();if(p&&Array.isArray(d.items))for(const u of d.items){let h;if(u.type==="placeholder"){const g=document.querySelector("#placeholderItemTpl");if(g){h=g.content.cloneNode(!0).firstElementChild,h.dataset.widthM=u.width_m||0,h.dataset.heightM=u.height_m||0;const f=h.querySelector("[data-placeholder-width]"),_=h.querySelector("[data-placeholder-height]");f&&(f.textContent=V(u.width_m)),_&&(_.textContent=V(u.height_m)),u.is_suspended&&h.classList.add("is-suspended")}else{console.warn("Placeholder template not found during load.");continue}}else if(u.type==="set")h=Te(u);else if(u.type==="wallpaper")h=Ce(u);else if(J[u.type]?.templateId==="#areaBasedTpl")h=Be(u.type,u);else continue;h&&p.appendChild(h)}}X(),Ae(),Z(),$e(),U(),H(),o&&b("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function Gt(e,o){const a=document.querySelector(m.printableContent);if(!a||!e){b("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(o==="direct"){b("กำลังสร้าง PDF...","default");let r;try{typeof window.html2pdf>"u"&&(b("กำลังโหลดไลบรารี PDF...","default"),await Mt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),r=document.createElement("div"),r.style.position="fixed",r.style.left="-300mm",r.style.top="0",r.style.width="210mm",r.style.background="#fff",r.innerHTML=e,document.body.appendChild(r),await new Promise(n=>setTimeout(n,300));const s={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:r.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:r.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(r).set(s).save(),b("ดาวน์โหลด PDF สำเร็จ","success")}catch(s){console.error("PDF Generation Error:",s),b("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{r&&document.body.contains(r)&&document.body.removeChild(r)}}else o==="print"&&(a.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{a.innerHTML=""},1e3)},ut))}function Ut(e){if(!e||!e.html){b("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const o=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,a=new Blob([o],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`${e.fileName}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t),b("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(o){console.error("HTML Export Error:",o),b("สร้างไฟล์ HTML ล้มเหลว","error")}}function Yt(e){const{roomId:o,itemIndex:a}=e.dataset;if(!o||a===void 0)return;const t=document.getElementById("lookbookModal");t&&typeof t.closeModal=="function"&&t.closeModal({cancelled:!0});const r=document.getElementById(o);if(!r){b("ไม่พบห้องที่ต้องการ","error");return}const n=Array.from(r.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(a,10)];if(!n){b("ไม่พบรายการที่ต้องการ","error");return}r.open=!0,Z(),setTimeout(()=>{n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("scrolling-jump"),setTimeout(()=>n.classList.remove("scrolling-jump"),2500)},150)}function Jt(e){if(!ie)return;const o=ie.closest("#roomDefaultsModal"),a=ie.closest(".item-card"),t=ie.closest("#forceApplyModal");let r=ie,s=null;const n=r.dataset.favoriteType,i=e.dataset.code,l=v(e.dataset.price);if(a){let p;n==="fabric"?p="set_price_per_m":n==="sheer"?p="sheer_price_per_m":n==="wallpaper"?p="wallpaper_price_roll":p="area_price_sqyd",s=a.querySelector(`[name="${p}"]`)}else if(o){const p=r.closest(".defaults-inputs-grid");if(p){let u;n==="fabric"?u="defaults_fabric_price":n==="sheer"?u="defaults_sheer_price":n==="wallpaper"?u="defaults_wallpaper_price_roll":n==="wooden_blind"?u="defaults_wooden_blind_price_sqyd":n==="roller_blind"?u="defaults_roller_blind_price_sqyd":n==="vertical_blind"?u="defaults_vertical_blind_price_sqyd":n==="partition"?u="defaults_partition_price_sqyd":n==="pleated_screen"?u="defaults_pleated_screen_price_sqyd":n==="aluminum_blind"&&(u="defaults_aluminum_blind_price_sqyd"),u&&(s=p.querySelector(`[name="${u}"]`))}}else t&&(s=t.querySelector('[name="force_apply_price"]'));const d=s;r.value=i,r.classList.add("input-highlight"),setTimeout(()=>{r&&r.classList.remove("input-highlight")},1200),d&&l>=0&&(d.tagName==="SELECT"?Array.from(d.options).some(p=>v(p.value)===l)?d.value=l:b(`ราคา ${S(l)} ไม่มีในตัวเลือก`,"warning"):d.value=l===0?"0":l>0?S(l):"",d.classList.add("input-highlight"),setTimeout(()=>{d&&d.classList.remove("input-highlight")},1200)),a?((d||r).dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))):(o||t)&&d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}));const c=document.querySelector("#favoritesModal");c&&typeof c.closeModal=="function"&&c.closeModal({cancelled:!1,applied:!0})}async function zt(e){if(!e||!e.dataset.favoriteType){console.warn("showFavoritesModal called without a valid input element or favorite type.");return}ie=e;const o=e.dataset.favoriteType;if(!o){b("โปรดเลือกประเภทรายการก่อน","warning");const g=e.closest("#forceApplyModal");g&&g.querySelector("#forceApplySelectTypeBtn")?.focus(),ie=null;return}const a=document.querySelector("#favoritesModal"),t=a.querySelector("#favoritesModalTitle"),r=a.querySelector("#favoritesModalBody"),s=a.querySelector("#favSearchInput"),n=a.querySelector('[data-act="manage-favorites"]'),i=document.querySelector("#favSelectorItemTpl");if(!a||!t||!r||!s||!n||!i){console.error("Missing elements for favorites modal");return}let l=J[o]?.name||o;o==="fabric"?l="ผ้าทึบ":o==="sheer"&&(l="ผ้าโปร่ง"),t.textContent=`เลือก '${L(l)}'`;const d=()=>{const y=ce()[o]||[];y.length>0?r.innerHTML=y.map(f=>{let _="-";return f.price>=0&&(_=S(f.price)),i.innerHTML.replace(/{CODE}/g,L(f.code)).replace(/{PRICE}/g,_).replace(/{RAW_PRICE}/g,f.price)}).join(""):r.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',s.value=""};d();const c=()=>{const g=s.value.toLowerCase();r.querySelectorAll(".fav-selector-item").forEach(y=>{const f=y.dataset.code.toLowerCase();y.classList.toggle("is-hidden",!f.includes(g))})},p=g=>{const y=g.target.closest(".fav-selector-item");y&&Jt(y)},u=async()=>{await it(o),we&&d()},h=()=>{s.removeEventListener("input",c),r.removeEventListener("click",p),n&&(n.onclick=null)};s.addEventListener("input",c),r.addEventListener("click",p),n.onclick=u,await P("#favoritesModal",h)}function xe(e){const o=document.querySelector("#favManagerBody"),a=document.querySelector("#favManagerItemTpl"),r=ce()[e]||[];if(!o||!a)return;r.length===0?o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':o.innerHTML=r.map(i=>{let l="-";return i.price>=0&&(l=S(i.price)),a.innerHTML.replace(/{CODE}/g,L(i.code)).replace(/{PRICE}/g,l).replace(/{RAW_PRICE}/g,i.price)}).join(""),F=null;const s=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),n=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');s&&(s.disabled=!0),n&&(n.disabled=!0)}async function it(e){const o=document.querySelector("#favManagerModal");if(!o||!e)return;let a=J[e]?.name||e;e==="fabric"?a="ผ้าทึบ":e==="sheer"&&(a="ผ้าโปร่ง"),o.dataset.currentType=e,we=!1,F=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${L(a)}'`,xe(e),await P("#favManagerModal")}function Qt(e){if(!e||!e.matches(m.itemCard)||e.classList.contains("placeholder-item"))return null;const o=e.dataset.type;if(!o)return null;let a={type:o,is_suspended:e.classList.contains("is-suspended")};try{if(o==="set")Object.assign(a,{width_m:v(e.querySelector(m.setWidthInput)?.value),height_m:v(e.querySelector(m.setHeightInput)?.value),style:e.querySelector(m.setStyleSelect)?.value||"",fabric_variant:e.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:v(e.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:v(e.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:v(e.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:e.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:e.querySelector(m.setSheerCodeInput)?.value||"",opening_style:e.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:e.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:e.querySelector('input[name="track_color"]')?.value||"ขาว",bracket_color:e.querySelector('input[name="bracket_color"]')?.value||"ขาว",finial_color:e.querySelector('input[name="finial_color"]')?.value||"ขาว",grommet_color:e.querySelector('input[name="grommet_color"]')?.value||"เงิน",louis_valance:e.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:e.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:e.querySelector(m.setNotesInput)?.value||""});else if(o==="wallpaper"){const t=e.querySelector(m.wallInstallCostInput),r=t?t.value:"";let s;r==="0"?s=0:v(r)>0?s=v(r):s=void 0,Object.assign(a,{height_m:v(e.querySelector(m.wallHeightInput)?.value),wallpaper_code:e.querySelector(m.wallCodeInput)?.value||"",price_per_roll:v(e.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:s,notes:e.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(e.querySelectorAll(m.wallWidthInput)).map(n=>v(n.value))})}else e.matches(m.areaBasedItem)&&(Object.assign(a,{width_m:v(e.querySelector(m.areaWidthInput)?.value),height_m:v(e.querySelector(m.areaHeightInput)?.value),price_sqyd:v(e.querySelector(m.areaPriceSqydInput)?.value),code:e.querySelector(m.areaCodeInput)?.value||"",notes:e.querySelector(m.areaNotesInput)?.value||""}),(o==="partition"||o==="pleated_screen")&&(a.opening_style=e.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(o)&&(a.adjustment_side=e.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));return a}catch(t){return console.error("Failed to extract item data:",t,e),null}}function Kt(e){if(!e)return;const o=e.closest(m.room);if(!o||!o.getItemsContainer())return;oe(O()),U();let t;if(e.classList.contains("placeholder-item")){const r=document.querySelector("#placeholderItemTpl");if(r){t=r.content.cloneNode(!0).firstElementChild,t.dataset.widthM=e.dataset.widthM,t.dataset.heightM=e.dataset.heightM;const n=t.querySelector("[data-placeholder-width]"),i=t.querySelector("[data-placeholder-height]");n&&(n.textContent=V(e.dataset.widthM)),i&&(i.textContent=V(e.dataset.heightM)),e.classList.contains("is-suspended")&&t.classList.add("is-suspended")}else{b("ไม่พบ Template สำหรับ Placeholder","error");return}}else{const r=Qt(e);if(!r){b("ไม่สามารถคัดลอกรายการได้","error");return}if(r.type==="set")t=Te(r);else if(r.type==="wallpaper")t=Ce(r);else if(J[r.type]?.templateId==="#areaBasedTpl")t=Be(r.type,r);else{b("ไม่รู้จักประเภทรายการ","error");return}}if(t){if(e.after(t),t.classList.add("item-created"),!t.classList.contains("placeholder-item")){const r=e.querySelector(m.itemDetailsMore);r&&r.classList.contains("show")&&Le(t,!0)}_e(t),X(),H(),b("คัดลอกรายการแล้ว","success")}}function Xt(){const e=document.querySelector(m.orderForm),o=document.querySelector(m.fileImporter),a=document.querySelector("#favImporter"),t=document.querySelector(m.menuDropdown),r=document.querySelector(m.quickNavDropdown),s=document.querySelector(m.menuBtn),n=document.querySelector(m.quickNavBtn);if(e){if(e.addEventListener("item-update",H),e.addEventListener("input",i=>{if(G){i.preventDefault();return}if(i.target.closest("#customerInfo")&&W(),i.target.matches(m.roomNameInput)){const d=i.target.closest(".room-card")?.querySelector("[data-room-name-display]");d&&(d.textContent=i.target.value||"ห้อง"),Ae(),$e(),qe(W,300)()}i.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&H()}),e.addEventListener("change",i=>{if(G){i.preventDefault();return}i.target.matches("select")&&H()}),e.addEventListener("blur",i=>{const l=i.target;l.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?l.name==="wallpaper_install_cost"&&v(l.value)===0?l.value="0":l.value=v(l.value)>0?S(v(l.value)):"":l.matches('input[name$="_m"], input[name^="wall_width_m"], input[name^="modal_"]')&&(l.value=V(l.value)),!l.closest(".modal-wrapper")&&l.matches('input:not([type="hidden"]), select, textarea')&&W()},!0),e.addEventListener("focusin",i=>{const l=i.target;if(l.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&(l.name==="wallpaper_install_cost"&&l.value==="0"||v(l.value)>0&&(l.value=v(l.value))),l.matches('input:not([type="hidden"]), select, textarea')){const d=document.querySelector(".main-header"),c=document.querySelector(".summary-footer"),p=d?d.offsetHeight+16:80,u=c?c.offsetHeight+16:100,h=window.innerHeight,g=l.getBoundingClientRect();if((g.top<p||g.bottom>h-u)&&!l.closest(".modal-wrapper")){const f=l.closest(".item-card, .room-card");f&&_e(f)}}},!0),e.addEventListener("keydown",i=>{if(G){i.preventDefault();return}const l=i.target;if(i.key==="Enter"&&l.matches("input, select")&&!l.closest(".modal-wrapper"))i.preventDefault();else if(i.key==="Enter"&&l.closest("#dimensionEntryModal")){const d=l.closest("#dimensionEntryModal"),c=d.querySelectorAll(".dimension-input-row"),u=c[c.length-1].querySelector('input[name="modal_height_m"]');l===u&&(i.preventDefault(),d.querySelector("#dimensionEntryConfirm")?.click())}}),document.addEventListener("click",async i=>{i.target.closest(".menu-container")||(t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),r?.classList.remove("show"),n?.setAttribute("aria-expanded","false")),i.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show"));const l=i.target.closest(".summary-tag[data-filter-type]");if(l&&l.closest("#overviewModal")){const p=l.dataset.filterType,u=l.textContent.trim().replace(/\s*\d+\s*$/,""),h=document.querySelector("#overviewModal");h&&typeof h.closeModal=="function"&&h.closeModal({cancelled:!0}),It(p,u);return}const d=i.target.closest(".fav-manager-item");if(d){const p=d.closest("#favManagerModal"),u=p?.querySelector(".fav-manager-item.is-selected");u&&u.classList.remove("is-selected"),u!==d?(d.classList.add("is-selected"),F={code:d.dataset.code,price:v(d.dataset.price)}):F=null,p&&(p.querySelector('[data-act="edit-selected-fav"]').disabled=!F,p.querySelector('[data-act="del-selected-fav"]').disabled=!F);return}const c=i.target.closest("[data-act]");if(c){const p=c.dataset.act,u=c.closest(".item-card"),h=c.closest(".room-card"),g=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item","manage-favorites","show-favorites"];if(G&&!c.closest(".unlockable")&&!g.includes(p)){b("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room","remove-dimension-row"].includes(p)||i.preventDefault(),p!=="close-modal"&&i.stopPropagation(),p){case"show-discount-modal":Ct();break;case"show-suspended-items":De();break;case"clear-filter":st();break;case"add-room":he();break;case"add-item":if(h){const y=document.querySelector("#dimensionEntryModal");if(y){const f=y.querySelector("#dimensionRowsContainer");f.innerHTML="";const _=Xe();f.appendChild(_),_.querySelector('input[name="modal_width_m"]')?.focus();const w=await P("#dimensionEntryModal");if(w&&!w.cancelled){const k=[];if(f.querySelectorAll(".dimension-input-row").forEach(x=>{const q=x.querySelector('input[name="modal_width_m"]'),$=x.querySelector('input[name="modal_height_m"]'),T=v(q.value),M=v($.value);T>0&&M>0&&k.push({width_m:T,height_m:M})}),k.length>0){oe(O()),U();let x=null;k.forEach(q=>{const $=jt(q,h);x||(x=$)}),x&&(X(),W(),_e(x),b(`เพิ่ม ${k.length} รายการ (รอเลือกประเภท)`,"success"))}else b("ไม่มีขนาดที่ถูกต้องระบุ","warning")}}}break;case"add-dimension-row":{const y=document.querySelector("#dimensionRowsContainer");if(y){const f=Xe();y.appendChild(f),f.querySelector('input[name="modal_width_m"]')?.focus(),y.scrollTop=y.scrollHeight}break}case"remove-dimension-row":{const y=c.closest(".dimension-input-row"),f=y?.parentElement;y&&f&&f.children.length>1&&y.remove();break}case"select-item-type":if(u&&u.classList.contains("placeholder-item")){const y={width_m:parseFloat(u.dataset.widthM||0),height_m:parseFloat(u.dataset.heightM||0)};if(y.width_m>0&&y.height_m>0){const f=await lt("เลือกประเภทสินค้า");f&&Vt(u,f,y)}else b("ขนาดไม่ถูกต้องบน Placeholder","error")}break;case"collapse-room":h&&(h.open=!1,setTimeout(()=>{Z(),W()},50));break;case"toggle-room-menu":c.nextElementSibling?.classList.toggle("show");break;case"open-room-defaults":h&&(At(h),c.closest(".room-options-menu")?.classList.remove("show"));break;case"apply-room-defaults":Pt();break;case"open-force-apply-modal":Et();break;case"force-apply-defaults":Nt();break;case"toggle-suspend-room":h&&(h.classList.toggle("is-suspended"),c.closest(".room-options-menu")?.classList.remove("show"),H(),ye==="suspended"?De():ve());break;case"clear-room":h&&await K("ล้างข้อมูลในห้อง","?")&&(oe(O()),U(),h.getItemsContainer().innerHTML="",X(),H(),b("ล้างแล้ว","success"));break;case"del-room":h&&await K("ลบห้อง","?")&&Pe(h,"ลบแล้ว");break;case"del-item":u&&await K("ลบรายการ","?")&&Pe(u,"ลบแล้ว");break;case"duplicate-item":u&&Kt(u);break;case"toggle-suspend":u&&(u.classList.toggle("is-suspended"),H(),ye==="suspended"?De():ve());break;case"change-type":u&&Wt(u);break;case"toggle-more-details":u&&!u.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(y=>{y.closest(".item-card")!==u&&Le(y.closest(".item-card"),!1)}),Le(u);break;case"open-hardware-modal":D=u,D&&Bt();break;case"apply-hardware-to-room":{const y=c.closest("#hardwareModal"),f=D?.closest(m.room);if(!y||!f||!D)break;const _=D.querySelector('[name="set_style"]');if(_?.value==="ม่านพับ"||_?.value==="หลุยส์"){b("ไม่สามารถใช้กับม่านพับหรือม่านหลุยส์ได้","warning");break}const w=y.querySelector('[name="modal_track_color"]').value,k=y.querySelector('[name="modal_bracket_color"]').value,x=y.querySelector('[name="modal_finial_color"]').value,q=y.querySelector('[name="modal_grommet_color"]').value;f.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"])):not(:has(select[name="set_style"][value="หลุยส์"]))').forEach($=>{$.querySelector('[name="track_color"]').value=w,$.querySelector('[name="bracket_color"]').value=k,$.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&($.querySelector('[name="finial_color"]').value=x,$.querySelector('[name="grommet_color"]').value=q)}),W(),b("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const y=c.closest(".walls-section")?.querySelector("[data-walls-container]");if(y){const f=Fe();f&&(y.appendChild(f),f.querySelector("input")?.focus(),H())}break}case"del-wall":{const y=c.closest(".wall-input-row");y&&await K("ลบผนัง","?")&&Pe(y,"ลบแล้ว");break}case"show-favorites":{const y=c.previousElementSibling?.matches("input[data-favorite-type]")?c.previousElementSibling:c.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");y?zt(y):console.warn("Could not find associated input for show-favorites button:",c);break}case"add-new-fav-form":{const f=c.closest("#favManagerModal")?.dataset.currentType;if(!f)break;const _=document.querySelector("#favAddModal");if(!_)break;let w=J[f]?.name||f;f==="fabric"?w="ผ้าทึบ":f==="sheer"&&(w="ผ้าโปร่ง"),_.querySelector("h3").textContent=`เพิ่ม '${w}'`;const k=_.querySelector('[name="fav_code_add"]'),x=_.querySelector('[name="fav_price_add"]');k.value="",x.value="";const q=await P("#favAddModal");if(q&&!q.cancelled){const $=k.value.trim(),T=v(x.value);$&&T>=0?Ue(f,$,T)?(we=!0,xe(f),b("เพิ่มแล้ว","success")):b("ล้มเหลว","error"):b($?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!F)break;const f=c.closest("#favManagerModal")?.dataset.currentType;if(!f)break;const _=document.querySelector("#favEditModal");if(!_)break;_.querySelector("h3").textContent=`แก้ไข '${F.code}'`;const w=_.querySelector('[name="fav_code_edit"]'),k=_.querySelector('[name="fav_price_edit"]');w.value=F.code,k.value=F.price!==null&&F.price>=0?F.price:"";const x=await P("#favEditModal");if(x&&!x.cancelled){const q=w.value.trim(),$=v(k.value);q&&$>=0?(q!==F.code&&Ye(f,F.code),Ue(f,q,$),we=!0,xe(f),b("แก้ไขรายการโปรดแล้ว","success")):b(q?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!F)break;const f=c.closest("#favManagerModal")?.dataset.currentType;if(!f)break;await K("ลบรายการโปรด",`"${F.code}"?`)&&(Ye(f,F.code)?(we=!0,xe(f),b("ลบแล้ว","success")):b("ล้มเหลว","error"));break}case"manage-favorites-from-defaults":await Rt();break;case"jump-to-item":Yt(c);break}}else{const p=i.target.closest("summary");p&&p.closest("details.card")&&setTimeout(()=>{Z(),W()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",i=>{i.preventDefault(),xt()}),document.querySelector(m.lockBtn)?.addEventListener("click",i=>{i.preventDefault(),Ot()}),document.querySelector(m.toggleAllRoomsBtn)?.addEventListener("click",i=>{i.preventDefault(),Ht()}),n&&r){n.addEventListener("click",l=>{l.stopPropagation(),t?.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show",d),n.setAttribute("aria-expanded",d),d&&s?.setAttribute("aria-expanded","false")}),document.querySelector(m.quickNavRoomList)?.addEventListener("click",l=>{const d=l.target.closest("a[data-jump-to]");if(d){l.preventDefault();const c=d.dataset.jumpTo,p=document.getElementById(c);p&&(p.open=!0,p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("scrolling-jump"),setTimeout(()=>p.classList.remove("scrolling-jump"),2500),setTimeout(Z,100)),r.classList.remove("show"),n.setAttribute("aria-expanded","false")}});const i=document.querySelector("#addRoomQuickNavBtn");if(i){const l=ft(he,700);i.addEventListener("click",d=>{d.stopPropagation(),l(),r.classList.remove("show"),n.setAttribute("aria-expanded","false")})}}s&&t&&s.addEventListener("click",i=>{i.stopPropagation(),r?.classList.remove("show");const l=!t.classList.contains("show");t.classList.toggle("show",l),s.setAttribute("aria-expanded",l),l&&n?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",i=>{i.preventDefault(),Lt(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const l=O(),d=document.querySelector("#overviewModalHeader"),c=document.querySelector("#overviewModalBody");if(d&&c){const p=l.rooms.reduce((g,y)=>g+(y.is_suspended?0:(y.items||[]).filter(f=>!f.is_placeholder&&!f.is_suspended&&(N.calculateSetPrice(f)?.total>0||N.calculateWallpaperPrice(f)?.total>0||N.calculateAreaBasedPrice(f)?.total>0)).length),0),u=document.querySelector(m.grandTotal)?.textContent||"0",h=l.rooms.filter(g=>!g.is_suspended&&g.items?.some(y=>!y.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${h}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${p}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,c.innerHTML=$t(l),P("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const l=document.querySelector(m.copyOptionsModal);if(!l)return;l.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await P(m.copyOptionsModal);if(d&&!d.cancelled){const c=l.querySelector('input[name="copy_option"]:checked').value,p=wt(O(),c);try{await navigator.clipboard.writeText(p),b("คัดลอกสำเร็จ!","success")}catch{b("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const l=document.querySelector("#visualReportsModal");if(!l)return;l.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await P("#visualReportsModal");if(d&&!d.cancelled){const c=l.querySelector('input[name="report_type_option"]:checked').value;if(c==="lookbook"){const p=O(),u=kt(p),h=document.querySelector("#lookbookModalBody");u&&h?(h.innerHTML=u,P("#lookbookModal")):b("ไม่มีข้อมูล","warning")}else b(`'${c}' ยังไม่พร้อม`,"default")}}),document.querySelector(m.exportPdfBtn)?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const l=await Tt();if(!l)return;const d=O(),c=qt(d,{vatRate:l.vatOption==="include"?te.baseVatRate:0,pageBreakBuffer:l.pageBreakBuffer,showDetails:l.showDetails});if(!c){b("ไม่มีรายการ","warning");return}l.exportMethod==="html"?Ut(c):Gt(c.html,l.exportMethod)}),document.querySelector(m.submitBtn)?.addEventListener("click",async i=>{if(i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),await K("ส่งข้อมูล","?")){const l=O();if(!l.customer_name&&!l.customer_phone){b("ใส่ชื่อ/เบอร์","warning");return}b("กำลังส่ง...","default");try{const d=await fetch(dt,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});d.ok?b("ส่งแล้ว!","success"):b(`ล้มเหลว: ${d.status}`,"error")}catch{b("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(m.importBtn)?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),o?.click()}),o?.addEventListener("change",i=>{const l=i.target.files?.[0];if(!l)return;const d=new FileReader;d.onload=async c=>{try{const p=JSON.parse(c.target.result);if(p&&typeof p=="object")await Ve(p,!0);else throw new Error("Invalid JSON")}catch(p){b("ไฟล์ JSON ไม่ถูก","error"),console.error(p)}},d.readAsText(l),i.target.value=null}),document.querySelector(m.exportBtn)?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");try{const l=O(),d=JSON.stringify(l,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),h=new Date,g=`${h.getFullYear()}${(h.getMonth()+1).toString().padStart(2,"0")}${h.getDate().toString().padStart(2,"0")}`,y=`${h.getHours().toString().padStart(2,"0")}${h.getMinutes().toString().padStart(2,"0")}`,f=ht(l.customer_name||"data");u.href=p,u.download=`MTR-${g}${y}-${f}.json`,u.click(),URL.revokeObjectURL(p),b("Export สำเร็จ","success")}catch{b("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),a?.click()}),a?.addEventListener("change",i=>{const l=i.target.files?.[0];if(!l)return;const d=new FileReader;d.onload=c=>{try{const p=JSON.parse(c.target.result),u=Re(p);u>0?b(`เพิ่ม ${u} รายการ`,"success"):b("ไม่พบรายการใหม่","default")}catch{b("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(l),i.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");try{const l=ce();if(Object.values(l).every(g=>g.length===0)){b("ไม่มีรายการ","warning");return}const d=JSON.stringify(l,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),h=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=p,u.download=`MTR-Favorites-${h}.json`,u.click(),URL.revokeObjectURL(p),b("Export สำเร็จ","success")}catch{b("Export ล้มเหลว","error")}}),document.querySelector(m.clearItemsBtn)?.addEventListener("click",async i=>{if(i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),await K("ล้างทุกรายการ","?")){oe(O()),U(),document.querySelectorAll(m.room).forEach(c=>{c.getItemsContainer().innerHTML=""});const l=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");l&&(l.value="amount"),d&&(d.value="0"),X(),H(),b("ล้างแล้ว","success")}}),document.querySelector(m.clearAllBtn)?.addEventListener("click",async i=>{if(i.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),await K("ลบข้อมูลทั้งหมด","คำเตือน! ข้อมูลทั้งหมดรวมถึงรายการโปรดจะถูกลบถาวร ยืนยันหรือไม่?")){const l=document.querySelector(m.roomsContainer);l&&(l.innerHTML=""),localStorage.removeItem(ge),yt(),b("ลบข้อมูลทั้งหมดแล้ว กำลังรีโหลด...","success"),setTimeout(()=>window.location.reload(),500)}}),document.querySelector("#roomDefaultsConfirmBtn")?.addEventListener("click",Dt),window.addEventListener("click",i=>{i.target.closest(".menu-container")||(t?.classList.remove("show"),r?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),n?.setAttribute("aria-expanded","false")),i.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const l=i.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const c=d.closest(".item-card");c!==l&&Le(c,!1)})}),window.addEventListener("beforeunload",W),document.querySelector("#forceApplySelectTypeBtn")?.addEventListener("click",async i=>{if(i.preventDefault(),G){b("ฟอร์มถูกล็อคอยู่","warning");return}const l=document.querySelector("#forceApplyTypeModal");if(!l)return;const d=document.querySelector('#forceApplyModal [name="force_apply_type_hidden"]')?.value;let c=l.querySelector(`input[name="force_apply_type_option"][value="${d}"]`);c||(c=l.querySelector('input[name="force_apply_type_option"]')),c&&(c.checked=!0);const p=await P("#forceApplyTypeModal");if(p&&!p.cancelled){const u=l.querySelector('input[name="force_apply_type_option"]:checked');if(u){const h=u.value,g=document.querySelector("#forceApplyModal"),y=g?.querySelector('[name="force_apply_type_hidden"]'),f=g?.querySelector("#forceApplySelectedTypeDisplay"),_=g?.querySelector('[name="force_apply_code"]'),w=_?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs"),k=u.closest("label")?.querySelector("strong"),x=k?k.textContent.trim():h;y&&(y.value=h),f&&(f.textContent=x),_&&(_.dataset.favoriteType=h,_.focus()),w&&(w.disabled=!1)}}})}}function Zt(){const e=document.querySelector(m.setTpl);if(!e)return;const o=e.content.querySelector(m.setPricePerMSelect),a=e.content.querySelector(m.setSheerPricePerMSelect),t=e.content.querySelector(m.setLouisPricePerMSelect),r=s=>{let n='<option value="" hidden>เลือกราคา</option>';return Array.isArray(s)?(s.forEach(i=>{n+=`<option value="${i}">${i.toLocaleString("th-TH")}</option>`}),n):(console.error("Price data for dropdown is not available or not an array.",s),n)};o&&(o.innerHTML=r(be.fabric)),a&&(a.innerHTML=r(be.sheer)),t&&(t.innerHTML=r(be.louis))}function eo(){Zt(),at(),Xt();try{const e=localStorage.getItem(ge);if(e&&e!=="null"&&e!=="{}"){const o=JSON.parse(e);if(o&&Array.isArray(o.rooms))Ve(o,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(ge),he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}}else{he();const o=document.querySelector(m.customerCard);o&&(o.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(ge),he();const o=document.querySelector(m.customerCard);o&&(o.open=!0)}H(),nt(),Z(),$e(),U(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",eo);
